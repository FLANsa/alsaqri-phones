<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Users - Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Setup Firebase Users</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>
    
    <div>
        <button onclick="createAdminUser()">Create Admin User</button>
        <button onclick="createUserAccount()">Create User Account</button>
        <button onclick="checkUsers()">Check Existing Users</button>
    </div>

    <script type="module" src="js/firebase-config.js"></script>
    <script type="module">
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            resultsDiv.appendChild(div);
            console.log(message);
        }

        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseAuth && window.firebaseDB) {
                        log('‚úÖ Firebase loaded successfully', 'success');
                        resolve();
                    } else {
                        log('‚è≥ Waiting for Firebase...', 'info');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Create admin user
        window.createAdminUser = async function() {
            try {
                await waitForFirebase();
                log('üîê Creating admin user...', 'info');
                
                const adminCredential = await createUserWithEmailAndPassword(
                    window.firebaseAuth, 
                    'admin@alsaqri.com', 
                    'admin123'
                );
                
                const adminUser = adminCredential.user;
                log(`‚úÖ Admin user created! UID: ${adminUser.uid}`, 'success');
                
                // Create user document in Firestore
                await setDoc(doc(window.firebaseDB, 'authorized_users', adminUser.uid), {
                    email: 'admin@alsaqri.com',
                    role: 'admin',
                    name: 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ',
                    created_at: new Date().toISOString()
                });
                
                log('‚úÖ Admin user document created in Firestore', 'success');
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    log('‚ö†Ô∏è Admin user already exists', 'warning');
                } else {
                    log(`‚ùå Error creating admin user: ${error.message}`, 'error');
                }
            }
        };

        // Create user account
        window.createUserAccount = async function() {
            try {
                await waitForFirebase();
                log('üë§ Creating user account...', 'info');
                
                const userCredential = await createUserWithEmailAndPassword(
                    window.firebaseAuth, 
                    'user@alsaqri.com', 
                    'user123'
                );
                
                const user = userCredential.user;
                log(`‚úÖ User account created! UID: ${user.uid}`, 'success');
                
                // Create user document in Firestore
                await setDoc(doc(window.firebaseDB, 'authorized_users', user.uid), {
                    email: 'user@alsaqri.com',
                    role: 'user',
                    name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ',
                    created_at: new Date().toISOString()
                });
                
                log('‚úÖ User account document created in Firestore', 'success');
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    log('‚ö†Ô∏è User account already exists', 'warning');
                } else {
                    log(`‚ùå Error creating user account: ${error.message}`, 'error');
                }
            }
        };

        // Check existing users
        window.checkUsers = async function() {
            try {
                await waitForFirebase();
                log('üîç Checking existing users...', 'info');
                
                // Check admin user
                try {
                    const adminCredential = await signInWithEmailAndPassword(
                        window.firebaseAuth, 
                        'admin@alsaqri.com', 
                        'admin123'
                    );
                    log(`‚úÖ Admin user exists! UID: ${adminCredential.user.uid}`, 'success');
                    
                    const adminDoc = await getDoc(doc(window.firebaseDB, 'authorized_users', adminCredential.user.uid));
                    if (adminDoc.exists()) {
                        log(`‚úÖ Admin document: ${JSON.stringify(adminDoc.data())}`, 'success');
                    } else {
                        log('‚ö†Ô∏è Admin document not found in Firestore', 'warning');
                    }
                } catch (adminError) {
                    log(`‚ùå Admin user check failed: ${adminError.message}`, 'error');
                }
                
                // Check user account
                try {
                    const userCredential = await signInWithEmailAndPassword(
                        window.firebaseAuth, 
                        'user@alsaqri.com', 
                        'user123'
                    );
                    log(`‚úÖ User account exists! UID: ${userCredential.user.uid}`, 'success');
                    
                    const userDoc = await getDoc(doc(window.firebaseDB, 'authorized_users', userCredential.user.uid));
                    if (userDoc.exists()) {
                        log(`‚úÖ User document: ${JSON.stringify(userDoc.data())}`, 'success');
                    } else {
                        log('‚ö†Ô∏è User document not found in Firestore', 'warning');
                    }
                } catch (userError) {
                    log(`‚ùå User account check failed: ${userError.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error checking users: ${error.message}`, 'error');
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await waitForFirebase();
                statusDiv.textContent = 'Firebase ready! Click buttons to setup users.';
            } catch (error) {
                log(`‚ùå Initialization error: ${error.message}`, 'error');
                statusDiv.textContent = 'Error loading Firebase';
            }
        });
    </script>
</body>
</html>
