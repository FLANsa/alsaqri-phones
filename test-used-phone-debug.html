<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار إضافة هاتف مستعمل</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>اختبار إضافة هاتف مستعمل</h1>
    
    <form id="testForm">
        <div class="form-group">
            <label>الشركة:</label>
            <input type="text" id="brand" value="Apple" required>
        </div>
        
        <div class="form-group">
            <label>الموديل:</label>
            <input type="text" id="model" value="iPhone 13" required>
        </div>
        
        <div class="form-group">
            <label>سعر الشراء:</label>
            <input type="number" id="purchase_price" value="1000" required>
        </div>
        
        <div class="form-group">
            <label>سعر البيع:</label>
            <input type="number" id="selling_price" value="1200" required>
        </div>
        
        <div class="form-group">
            <label>الرقم التسلسلي:</label>
            <input type="text" id="serial_number" value="SN123456" required>
        </div>
        
        <div class="form-group">
            <label>رقم الباركود:</label>
            <input type="text" id="barcode_input" value="123456">
        </div>
        
        <div class="form-group">
            <label>حالة الهاتف:</label>
            <select id="phone_condition" required>
                <option value="excellent">ممتازة</option>
                <option value="very_good">جيدة جداً</option>
                <option value="good">جيدة</option>
                <option value="fair">مقبولة</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>عمر البطارية (بالأشهر):</label>
            <input type="number" id="age" value="12" required>
        </div>
        
        <div class="form-group">
            <label>الوصف:</label>
            <input type="text" id="description" value="هاتف مستعمل بحالة جيدة">
        </div>
        
        <div class="form-group">
            <label>اسم العميل:</label>
            <input type="text" id="customer_name" value="أحمد محمد">
        </div>
        
        <div class="form-group">
            <label>رقم العميل:</label>
            <input type="text" id="customer_id" value="CUST001">
        </div>
        
        <div class="form-group">
            <label>لون الهاتف:</label>
            <input type="text" id="phone_color" value="أزرق">
        </div>
        
        <div class="form-group">
            <label>الذاكرة:</label>
            <input type="text" id="phone_memory" value="128GB">
        </div>
        
        <div class="form-group">
            <label>اسم المشتري:</label>
            <input type="text" id="buyer_name" value="محمد أحمد">
        </div>
        
        <button type="submit">اختبار الحفظ</button>
    </form>
    
    <div id="log" class="log"></div>

    <!-- Firebase Configuration -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/firebase-database.js"></script>
    <script type="module" src="js/firebase-storage-manager.js"></script>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            console.log(message);
        }

        // توليد رقم هاتف تلقائي
        function generatePhoneNumber() {
            const timestamp = Date.now().toString().slice(-6);
            return timestamp.padStart(6, '0');
        }

        // حفظ بيانات الهاتف المستعمل في Firebase
        async function saveUsedPhoneToFirebase() {
            try {
                log('🔄 بدء حفظ الهاتف المستعمل...');
                
                // جمع بيانات النموذج
                const phoneData = {
                    brand: document.getElementById('brand').value,
                    model: document.getElementById('model').value,
                    condition: 'used',
                    purchase_price: parseFloat(document.getElementById('purchase_price').value) || 0,
                    selling_price: parseFloat(document.getElementById('selling_price').value) || 0,
                    serial_number: document.getElementById('serial_number').value,
                    phone_number: document.getElementById('barcode_input').value.trim() || generatePhoneNumber(),
                    phone_condition: document.getElementById('phone_condition').value,
                    age: parseInt(document.getElementById('age').value) || 0,
                    description: document.getElementById('description').value,
                    customer_name: document.getElementById('customer_name').value,
                    customer_id: document.getElementById('customer_id').value,
                    phone_color: document.getElementById('phone_color').value,
                    phone_memory: document.getElementById('phone_memory').value,
                    buyer_name: document.getElementById('buyer_name').value,
                    date_added: new Date().toISOString()
                };

                log('📱 بيانات الهاتف: ' + JSON.stringify(phoneData, null, 2));

                // التحقق من البيانات المطلوبة
                if (!phoneData.brand || !phoneData.model || !phoneData.serial_number) {
                    log('❌ بيانات مطلوبة مفقودة');
                    alert('يرجى ملء جميع الحقول المطلوبة');
                    return false;
                }

                if (phoneData.purchase_price <= 0 || phoneData.selling_price <= 0) {
                    log('❌ أسعار غير صحيحة');
                    alert('يرجى إدخال أسعار صحيحة');
                    return false;
                }

                if (!phoneData.phone_condition) {
                    log('❌ حالة الهاتف مطلوبة');
                    alert('يرجى اختيار حالة الهاتف');
                    return false;
                }

                log('✅ جميع البيانات صحيحة');

                // التحقق من Firebase
                if (window.storage && window.storage.isFirebaseAvailable) {
                    log('🔥 Firebase متاح، محاولة الحفظ...');
                    const phoneId = await window.storage.addPhone(phoneData);
                    if (phoneId) {
                        log('✅ تم حفظ الهاتف المستعمل في Firebase: ' + phoneId);
                        alert('✅ تم إضافة الهاتف المستعمل بنجاح!');
                        return true;
                    } else {
                        log('❌ فشل في الحصول على ID من Firebase');
                        return false;
                    }
                } else {
                    log('💾 Firebase غير متاح، استخدام LocalStorage...');
                    // حفظ في LocalStorage كبديل
                    const phones = JSON.parse(localStorage.getItem('phones') || '[]');
                    phoneData.id = Date.now().toString();
                    phones.push(phoneData);
                    localStorage.setItem('phones', JSON.stringify(phones));
                    log('✅ تم حفظ الهاتف المستعمل في LocalStorage');
                    alert('✅ تم إضافة الهاتف المستعمل بنجاح! (محلي)');
                    return true;
                }
            } catch (error) {
                log('❌ خطأ في حفظ الهاتف المستعمل: ' + error.message);
                log('❌ تفاصيل الخطأ: ' + error.stack);
                alert('❌ حدث خطأ في حفظ الهاتف. حاول مرة أخرى.');
                return false;
            }
        }

        // ربط نموذج الإرسال
        document.addEventListener('DOMContentLoaded', async () => {
            log('🔄 انتظار تحميل Firebase...');
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            if (window.storage) {
                log('✅ Storage Manager محمل');
                log('🔥 Firebase متاح: ' + window.storage.isFirebaseAvailable);
            } else {
                log('❌ Storage Manager غير محمل');
            }
            
            const form = document.getElementById('testForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                log('📝 بدء إرسال النموذج...');
                const success = await saveUsedPhoneToFirebase();
                if (success) {
                    log('🎉 تم الحفظ بنجاح!');
                } else {
                    log('💥 فشل في الحفظ');
                }
            });
        });
    </script>
</body>
</html>
