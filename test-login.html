<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login - Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Firebase Login Test</h1>
    <div id="status">Loading...</div>
    
    <form id="testForm">
        <input type="email" id="email" placeholder="Email" value="admin@alsaqri.com">
        <input type="password" id="password" placeholder="Password">
        <button type="submit">Test Login</button>
    </form>
    
    <div id="result"></div>

    <script type="module" src="js/firebase-config.js"></script>
    <script type="module">
        import { signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            resultDiv.appendChild(div);
            console.log(message);
        }

        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseAuth && window.firebaseDB) {
                        log('‚úÖ Firebase loaded successfully', 'success');
                        resolve();
                    } else {
                        log('‚è≥ Waiting for Firebase...', 'info');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Test login
        async function testLogin(email, password) {
            try {
                log(`üîê Attempting login with: ${email}`, 'info');
                
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                log(`‚úÖ Login successful! UID: ${user.uid}`, 'success');
                
                // Test getting user role
                try {
                    const userDoc = await getDoc(doc(window.firebaseDB, 'authorized_users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        log(`‚úÖ User role found: ${userData.role}`, 'success');
                        log(`üìÑ User data: ${JSON.stringify(userData)}`, 'info');
                    } else {
                        log('‚ö†Ô∏è User document not found in authorized_users collection', 'error');
                    }
                } catch (roleError) {
                    log(`‚ùå Error getting user role: ${roleError.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Login failed: ${error.code} - ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await waitForFirebase();
                statusDiv.textContent = 'Firebase ready!';
                
                document.getElementById('testForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    await testLogin(email, password);
                });
                
            } catch (error) {
                log(`‚ùå Initialization error: ${error.message}`, 'error');
                statusDiv.textContent = 'Error loading Firebase';
            }
        });
    </script>
</body>
</html>
