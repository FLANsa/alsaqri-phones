<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبار النظام — الصقري للاتصالات</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
    .test-section { margin: 20px 0; }
    .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
  </style>
</head>
<body>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h1 class="text-center mb-4">
        <i class="fas fa-cogs"></i> اختبار نظام الصقري للاتصالات
      </h1>
    </div>
  </div>

  <!-- System Status -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-info-circle"></i> حالة النظام</h5>
        </div>
        <div class="card-body">
          <div id="system-status">
            <p><i class="fas fa-spinner fa-spin"></i> جاري فحص النظام...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-database"></i> إحصائيات البيانات</h5>
        </div>
        <div class="card-body">
          <div id="data-stats">
            <p><i class="fas fa-spinner fa-spin"></i> جاري تحميل الإحصائيات...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-play"></i> اختبارات النظام</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <button class="btn btn-primary w-100" onclick="testPhoneManager()">
                <i class="fas fa-mobile-alt"></i><br>اختبار إدارة الهواتف
              </button>
            </div>
            <div class="col-md-3 mb-2">
              <button class="btn btn-info w-100" onclick="testAccessoryManager()">
                <i class="fas fa-box"></i><br>اختبار إدارة الأكسسوارات
              </button>
            </div>
            <div class="col-md-3 mb-2">
              <button class="btn btn-success w-100" onclick="testSalesManager()">
                <i class="fas fa-shopping-cart"></i><br>اختبار إدارة المبيعات
              </button>
            </div>
            <div class="col-md-3 mb-2">
              <button class="btn btn-warning w-100" onclick="testBarcodeGenerator()">
                <i class="fas fa-barcode"></i><br>اختبار الباركود
              </button>
            </div>
          </div>
          
          <hr>
          
          <div class="row">
            <div class="col-md-6 mb-2">
              <button class="btn btn-secondary w-100" onclick="clearAllData()">
                <i class="fas fa-trash"></i> مسح جميع البيانات
              </button>
            </div>
            <div class="col-md-6 mb-2">
              <button class="btn btn-outline-primary w-100" onclick="loadSampleData()">
                <i class="fas fa-database"></i> تحميل بيانات تجريبية
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Results -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-list"></i> نتائج الاختبارات</h5>
        </div>
        <div class="card-body">
          <div id="test-results">
            <p class="text-muted">لا توجد نتائج بعد. اضغط على أزرار الاختبار أعلاه.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barcode Display -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-barcode"></i> عرض الباركود</h5>
        </div>
        <div class="card-body text-center">
          <div id="barcode-display">
            <p class="text-muted">سيظهر الباركود هنا عند الاختبار</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="row mt-4">
    <div class="col-12 text-center">
      <a href="index.html" class="btn btn-outline-secondary me-2">
        <i class="fas fa-home"></i> الصفحة الرئيسية
      </a>
      <a href="dashboard.html" class="btn btn-outline-primary me-2">
        <i class="fas fa-tachometer-alt"></i> لوحة التحكم
      </a>
      <a href="add_accessory.html" class="btn btn-outline-success">
        <i class="fas fa-plus"></i> إضافة أكسسوار
      </a>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Phone Store JavaScript Modules -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/storage.js"></script>
<script src="js/barcode.js"></script>
<script src="js/auth.js"></script>
<script src="js/phone-manager.js"></script>
<script src="js/accessory-manager.js"></script>
<script src="js/sales-manager.js"></script>
<script src="js/main.js"></script>

<!-- Test Functions -->
<script>
let testResultsContainer;

document.addEventListener('DOMContentLoaded', function() {
  testResultsContainer = document.getElementById('test-results');
  checkSystemStatus();
  updateDataStats();
});

function addTestResult(message, isSuccess = true) {
  const resultDiv = document.createElement('div');
  resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
  resultDiv.innerHTML = `
    <i class="fas fa-${isSuccess ? 'check' : 'times'}"></i> 
    ${message}
    <small class="float-end">${new Date().toLocaleTimeString('ar-SA')}</small>
  `;
  testResultsContainer.insertBefore(resultDiv, testResultsContainer.firstChild);
}

function checkSystemStatus() {
  const statusDiv = document.getElementById('system-status');
  let status = '<div class="row g-2">';
  
  try {
    // Check if all managers are loaded
    const managers = [
      { name: 'إدارة المصادقة', obj: window.authManager },
      { name: 'إدارة التخزين', obj: window.storage },
      { name: 'إدارة الهواتف', obj: window.phoneManager },
      { name: 'إدارة الأكسسوارات', obj: window.accessoryManager },
      { name: 'إدارة المبيعات', obj: window.salesManager },
      { name: 'مولد الباركود', obj: window.barcodeGenerator }
    ];

    managers.forEach(manager => {
      const isLoaded = !!manager.obj;
      status += `
        <div class="col-6">
          <span class="badge ${isLoaded ? 'bg-success' : 'bg-danger'}">
            <i class="fas fa-${isLoaded ? 'check' : 'times'}"></i> ${manager.name}
          </span>
        </div>
      `;
    });

    status += '</div>';
    statusDiv.innerHTML = status;
  } catch (error) {
    statusDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> خطأ في فحص النظام: ${error.message}</p>`;
  }
}

function updateDataStats() {
  const statsDiv = document.getElementById('data-stats');
  
  try {
    const stats = storage.getStorageStats();
    
    statsDiv.innerHTML = `
      <div class="row g-2 text-center">
        <div class="col-6">
          <div class="border rounded p-2">
            <h6 class="mb-1">${stats.phones}</h6>
            <small class="text-muted">هاتف</small>
          </div>
        </div>
        <div class="col-6">
          <div class="border rounded p-2">
            <h6 class="mb-1">${stats.accessories}</h6>
            <small class="text-muted">أكسسوار</small>
          </div>
        </div>
        <div class="col-6">
          <div class="border rounded p-2">
            <h6 class="mb-1">${stats.sales}</h6>
            <small class="text-muted">عملية بيع</small>
          </div>
        </div>
        <div class="col-6">
          <div class="border rounded p-2">
            <h6 class="mb-1">${stats.phoneTypes}</h6>
            <small class="text-muted">نوع هاتف</small>
          </div>
        </div>
      </div>
    `;
  } catch (error) {
    statsDiv.innerHTML = `<p class="text-danger">خطأ في تحميل الإحصائيات: ${error.message}</p>`;
  }
}

async function testPhoneManager() {
  try {
    const testPhone = {
      brand: 'Apple',
      model: 'iPhone 15 Test',
      condition: 'new',
      purchase_price: 3000,
      selling_price: 3500,
      serial_number: 'TEST' + Date.now(),
      warranty: 12,
      description: 'هاتف اختبار'
    };

    const result = await phoneManager.addPhone(testPhone);
    
    if (result.success) {
      addTestResult(`تم إضافة هاتف اختبار بنجاح: ${result.phone.brand} ${result.phone.model}`, true);
      updateDataStats();
    } else {
      addTestResult(`فشل في إضافة هاتف الاختبار: ${result.error}`, false);
    }
  } catch (error) {
    addTestResult(`خطأ في اختبار إدارة الهواتف: ${error.message}`, false);
  }
}

async function testAccessoryManager() {
  try {
    const testAccessory = {
      name: 'غطاء اختبار',
      category: 'case',
      description: 'أكسسوار للاختبار',
      purchase_price: 25,
      selling_price: 50,
      quantity: 10,
      supplier: 'مورد الاختبار'
    };

    const result = await accessoryManager.addAccessory(testAccessory);
    
    if (result.success) {
      addTestResult(`تم إضافة أكسسوار اختبار بنجاح: ${result.accessory.name}`, true);
      updateDataStats();
    } else {
      addTestResult(`فشل في إضافة أكسسوار الاختبار: ${result.error}`, false);
    }
  } catch (error) {
    addTestResult(`خطأ في اختبار إدارة الأكسسوارات: ${error.message}`, false);
  }
}

async function testSalesManager() {
  try {
    const phones = phoneManager.getAllPhones();
    const accessories = accessoryManager.getAllAccessories();
    
    if (phones.length === 0 && accessories.length === 0) {
      addTestResult('لا توجد منتجات لإنشاء عملية بيع. أضف هاتف أو أكسسوار أولاً.', false);
      return;
    }

    const saleItems = [];
    
    if (phones.length > 0) {
      saleItems.push({
        id: phones[0].id,
        type: 'phone',
        name: `${phones[0].brand} ${phones[0].model}`,
        unitPrice: phones[0].selling_price,
        quantity: 1
      });
    }

    if (accessories.length > 0 && accessories[0].quantity_in_stock > 0) {
      saleItems.push({
        id: accessories[0].id,
        type: accessories[0].category,
        name: accessories[0].name,
        unitPrice: accessories[0].selling_price,
        quantity: 1
      });
    }

    const testSale = {
      customer_name: 'عميل اختبار',
      customer_phone: '0555555555',
      payment_method: 'نقدي',
      items: saleItems
    };

    const result = await salesManager.createSale(testSale);
    
    if (result.success) {
      addTestResult(`تم إنشاء عملية بيع اختبار بنجاح: ${result.sale.sale_number}`, true);
      updateDataStats();
    } else {
      addTestResult(`فشل في إنشاء عملية بيع الاختبار: ${result.error}`, false);
    }
  } catch (error) {
    addTestResult(`خطأ في اختبار إدارة المبيعات: ${error.message}`, false);
  }
}

function testBarcodeGenerator() {
  try {
    const testPhoneNumber = '123456';
    const barcode = barcodeGenerator.generateSVGBarcode(testPhoneNumber);
    
    const barcodeDisplay = document.getElementById('barcode-display');
    barcodeDisplay.innerHTML = `
      <h6>باركود رقم: ${testPhoneNumber}</h6>
      ${barcode}
    `;
    
    addTestResult(`تم إنتاج باركود اختبار بنجاح للرقم: ${testPhoneNumber}`, true);
  } catch (error) {
    addTestResult(`خطأ في اختبار مولد الباركود: ${error.message}`, false);
  }
}

function clearAllData() {
  if (!confirm('هل أنت متأكد من مسح جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
    return;
  }

  try {
    storage.clearAllData();
    addTestResult('تم مسح جميع البيانات بنجاح', true);
    updateDataStats();
    
    // Clear barcode display
    document.getElementById('barcode-display').innerHTML = '<p class="text-muted">تم مسح عرض الباركود</p>';
  } catch (error) {
    addTestResult(`خطأ في مسح البيانات: ${error.message}`, false);
  }
}

async function loadSampleData() {
  try {
    // Add sample phones
    const samplePhones = [
      {
        brand: 'Apple',
        model: 'iPhone 15',
        condition: 'new',
        purchase_price: 3200,
        selling_price: 3700,
        serial_number: 'IP15-001',
        warranty: 12,
        description: 'آيفون 15 جديد'
      },
      {
        brand: 'Samsung',
        model: 'Galaxy S24',
        condition: 'used',
        purchase_price: 2500,
        selling_price: 2900,
        serial_number: 'GS24-002',
        phone_condition: 'excellent',
        age: 6,
        description: 'جالكسي S24 مستعمل'
      }
    ];

    // Add sample accessories
    const sampleAccessories = [
      {
        name: 'غطاء شفاف آيفون',
        category: 'case',
        description: 'غطاء حماية شفاف',
        purchase_price: 20,
        selling_price: 45,
        quantity: 50,
        supplier: 'شركة الأغطية المتقدمة'
      },
      {
        name: 'شاحن سريع 20W',
        category: 'charger',
        description: 'شاحن سريع USB-C',
        purchase_price: 35,
        selling_price: 65,
        quantity: 25,
        supplier: 'شركة الشواحن الذكية'
      }
    ];

    let successCount = 0;

    // Add phones
    for (const phone of samplePhones) {
      const result = await phoneManager.addPhone(phone);
      if (result.success) successCount++;
    }

    // Add accessories
    for (const accessory of sampleAccessories) {
      const result = await accessoryManager.addAccessory(accessory);
      if (result.success) successCount++;
    }

    addTestResult(`تم تحميل ${successCount} عنصر من البيانات التجريبية بنجاح`, true);
    updateDataStats();

  } catch (error) {
    addTestResult(`خطأ في تحميل البيانات التجريبية: ${error.message}`, false);
  }
}
</script>

</body>
</html>
