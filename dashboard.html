<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة التحكم — الصقري للاتصالات</title>

  <!-- نفس الخط/المكتبات المستخدمة في القالب -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    /* نفس التنسيقات المخصصة في الملف الأصلي */
    .card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .card-body { padding: 1.25rem; }
    .card-header { border-radius: 8px 8px 0 0 !important; font-weight: 600; }
    .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
      border: none; box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .card.bg-primary:hover, .card.bg-success:hover, .card.bg-info:hover, .card.bg-warning:hover {
      transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      .card-body { padding: 1rem; }
      h3 { font-size: 1.5rem; }
      .fa-2x { font-size: 1.5em; }
    }
  </style>
</head>
<body>

  <!-- شريط التنقل -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">الصقري للاتصالات</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="inventoryDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-boxes"></i> إدارة المخزون
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="inventory_summary.html"><i class="fas fa-chart-bar"></i> ملخص المخزون</a></li>
              <li><a class="dropdown-item" href="search.html"><i class="fas fa-search"></i> البحث في المخزون</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="add_accessory.html"><i class="fas fa-plus"></i> إضافة أكسسوار</a></li>
              <li><a class="dropdown-item" href="list_accessories_simple.html"><i class="fas fa-box"></i> مخزون الأكسسوارات</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="salesDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-shopping-cart"></i> إدارة المبيعات
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="list_sales.html"><i class="fas fa-list"></i> قائمة المبيعات</a></li>
              <li><a class="dropdown-item" href="create_sale.html"><i class="fas fa-plus-circle"></i> إنشاء عملية بيع جديدة</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="phoneDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-mobile-alt"></i> إدارة الهواتف
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="add_new_phone.html"><i class="fas fa-mobile"></i> هاتف جديد</a></li>
              <li><a class="dropdown-item" href="add_used_phone.html"><i class="fas fa-mobile-alt"></i> هاتف مستعمل</a></li>
            </ul>
          </li>

          <li class="nav-item">
          </li>
        </ul>
      </div>
    </div>
  </nav>

<div class="container-fluid mt-4">
  <!-- Main Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-3">
        <i class="fas fa-tachometer-alt text-primary"></i> لوحة التحكم
      </h2>
    </div>
  </div>

  <!-- Inventory Overview Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-mobile-alt fa-2x mb-2"></i>
          <h6 class="card-title mb-1">إجمالي الهواتف</h6>
          <h3 class="mb-0" id="total_phones">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-cash-register fa-2x mb-2"></i>
          <h6 class="card-title mb-1">عدد المبيعات</h6>
          <h3 class="mb-0" id="total_sales_count">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
          <h6 class="card-title mb-1">إجمالي المبيعات</h6>
          <h3 class="mb-0" id="total_sales_amount">0</h3>
          <small>ريال</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-coins fa-2x mb-2"></i>
          <h6 class="card-title mb-1">الربح الفعلي</h6>
          <h3 class="mb-0" id="total_actual_profit">0</h3>
          <small>ريال</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Details Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> القيم الشرائية</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-primary" id="total_purchase_value">0.00 ريال</h3>
          <p class="text-muted">إجمالي قيمة شراء المخزون المتاح</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-tags"></i> القيم البيعية</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-success" id="total_selling_value">0.00 ريال</h3>
          <p class="text-muted">إجمالي قيمة بيع المخزون المتاح</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> الربح المتوقع</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-warning" id="total_expected_profit">0.00 ريال</h3>
          <p class="text-muted">الربح المتوقع من المخزون المتاح</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Sales Performance Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-receipt"></i> المبيعات قبل الضريبة</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-success" id="total_sales_subtotal">0.00 ريال</h3>
          <p class="text-muted">إجمالي المبيعات قبل الضريبة</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="fas fa-percentage"></i> إجمالي الضريبة</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-danger" id="total_vat_amount">0.00 ريال</h3>
          <p class="text-muted">إجمالي ضريبة القيمة المضافة</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie"></i> نسبة الربح</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-info" id="profit_ratio">0%</h3>
          <p class="text-muted">نسبة الربح من المبيعات</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-bolt"></i> إجراءات سريعة</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <a href="create_sale.html" class="btn btn-success btn-lg w-100">
                <i class="fas fa-plus-circle"></i><br>إنشاء عملية بيع
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_new_phone.html" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-mobile"></i><br>إضافة هاتف جديد
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_accessory.html" class="btn btn-info btn-lg w-100">
                <i class="fas fa-box"></i><br>إضافة أكسسوار
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="search.html" class="btn btn-warning btn-lg w-100">
                <i class="fas fa-search"></i><br>البحث في المخزون
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Sales -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-history"></i> آخر المبيعات</h5>
        </div>
        <div class="card-body" id="recent_sales_wrap">
          <!-- واجهة فقط: اعرض رسالة فارغة. يمكنك لاحقًا ملؤها عبر JS من API -->
          <div class="text-center py-4">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">لا توجد مبيعات حديثة</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- مكتبات JS نفسها -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase Configuration -->
<script type="module" src="js/firebase-config.js"></script>
<script type="module" src="js/firebase-database.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- نظام لوحة التحكم مع التحقق من تسجيل الدخول -->
<script>
  // التحقق من تسجيل الدخول
    
    try {
      const userData = JSON.parse(currentUser);
      
      // التحقق من أن المستخدم مدير
      if (userData.role !== 'admin') {
        window.location.href = 'limited_dashboard.html';
        return false;
      }
      
      return true;
    } catch (error) {
      console.error('Error parsing user data:', error);
      window.location.href = 'login.html';
      return false;
    }
  }

  // تسجيل الخروج

  // ---------- أدوات مساعدة للوقت/التاريخ ----------
  // يحوّل أي مدخل تاريخ (Date | ISO string | number | Firestore Timestamp | {seconds/_seconds, nanoseconds/_nanoseconds}) إلى Date صالح
  function normalizeToDate(v) {
    if (v == null) return null;

    // 1) Date جاهز
    if (v instanceof Date) {
      return isNaN(v.getTime()) ? null : v;
    }

    // 2) Firestore Timestamp: toDate()
    if (typeof v === 'object') {
      if (typeof v.toDate === 'function') {
        const d = v.toDate();
        return isNaN(d?.getTime()) ? null : d;
      }
      // 3) شكل seconds/nanoseconds أو _seconds/_nanoseconds
      if ('seconds' in v || '_seconds' in v) {
        const sec  = Number(v.seconds ?? v._seconds ?? 0);
        const nsec = Number(v.nanoseconds ?? v._nanoseconds ?? 0);
        const ms = (sec * 1000) + Math.floor(nsec / 1e6);
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
    }

    // 4) رقم: ms أو s
    if (typeof v === 'number') {
      const ms = v > 1e12 ? v : v * 1000; // إذا أقل من 1e12 نفترض ثواني
      const d = new Date(ms);
      return isNaN(d.getTime()) ? null : d;
    }

    // 5) سترنق: ISO أو رقمية
    if (typeof v === 'string') {
      const s = v.trim();
      if (/^\d+$/.test(s)) {
        const n = parseInt(s, 10);
        const ms = n > 1e12 ? n : n * 1000;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
      const d = new Date(s); // مثل "2025-09-20T11:34:48.797Z"
      return isNaN(d.getTime()) ? null : d;
    }

    return null;
  }

  // يرجّع أفضل تاريخ موجود في السجل
  function getSaleDateValue(sale) {
    return (
      normalizeToDate(sale?.date_created) ||
      normalizeToDate(sale?.date_added)   ||
      normalizeToDate(sale?.createdAt)    ||
      normalizeToDate(sale?.created_at)   ||
      null
    );
  }

  // تحويل الأرقام العربية إلى لاتينية — يدعم المدخلات الرقمية
  function convertToLatinNumbers(input) {
    if (input == null) return '';
    const str = String(input);
    const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return str.replace(/[٠-٩]/g, d => map[d] || d);
  }

  // التحقق من بيع الهاتف
  function isPhoneSold(phoneId, salesData = []) {
    try {
      const sales = salesData.length > 0 ? salesData : JSON.parse(localStorage.getItem('sales') || '[]');
      return sales.some(sale =>
        Array.isArray(sale.items) &&
        sale.items.some(item => item.type === 'phone' && (item.id === phoneId || item.phone_id === phoneId))
      );
    } catch (error) {
      console.error('❌ خطأ في التحقق من بيع الهاتف:', error);
      return false;
    }
  }

  // تحديث لوحة التحكم بالبيانات الحقيقية
  async function updateDashboard() {
    try {
      // جلب البيانات من Firebase أو التخزين المحلي
      let phones = [];
      let accessories = [];
      let sales = [];
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        // استخدام Firebase
        phones = await window.storage.getPhones();
        accessories = await window.storage.getAccessories();
        sales = await window.storage.getSales();
      } else {
        // استخدام LocalStorage كبديل
        phones = JSON.parse(localStorage.getItem('phones') || '[]');
        accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        sales = JSON.parse(localStorage.getItem('sales') || '[]');
      }

      // تصفية الهواتف المباعة - إبقاء الهواتف المتاحة فقط
      const availablePhones = phones.filter(phone => {
        const phoneId = phone.id || phone.phone_number;
        return phoneId && !isPhoneSold(phoneId, sales);
      });

      console.log('📱 الهواتف المتاحة:', availablePhones.length, 'من أصل', phones.length);

      // تحديث إحصائيات الهواتف (الهواتف المتاحة فقط)
      const totalPhones = availablePhones.length;
      
      // حساب القيم للهواتف المتاحة فقط
      const phonesPurchaseValue = availablePhones.reduce((sum, phone) => sum + (phone.purchase_price || 0), 0);
      const phonesSellingValue = availablePhones.reduce((sum, phone) => sum + (phone.selling_price || 0), 0);
      
      // حساب القيم للأكسسوارات المتاحة (الكمية > 0)
      const availableAccessories = accessories.filter(acc => (acc.quantity_in_stock || acc.quantity || 0) > 0);
      const accessoriesPurchaseValue = availableAccessories.reduce((sum, acc) => sum + (acc.purchase_price || 0) * (acc.quantity_in_stock || acc.quantity || 0), 0);
      const accessoriesSellingValue = availableAccessories.reduce((sum, acc) => sum + (acc.selling_price || 0) * (acc.quantity_in_stock || acc.quantity || 0), 0);
      
      // إجمالي القيم (هواتف + أكسسوارات)
      const totalPurchaseValue = phonesPurchaseValue + accessoriesPurchaseValue;
      const totalSellingValue = phonesSellingValue + accessoriesSellingValue;
      const totalExpectedProfit = totalSellingValue - totalPurchaseValue;

      console.log('📱 الهواتف المتاحة:', availablePhones.length, 'من أصل', phones.length);
      console.log('📦 الأكسسوارات المتاحة:', availableAccessories.length, 'من أصل', accessories.length);
      console.log('💰 قيمة شراء الهواتف:', phonesPurchaseValue);
      console.log('💰 قيمة شراء الأكسسوارات:', accessoriesPurchaseValue);
      console.log('💰 إجمالي القيمة الشرائية:', totalPurchaseValue);

      document.getElementById('total_phones').textContent = convertToLatinNumbers(totalPhones);
      document.getElementById('total_purchase_value').textContent = convertToLatinNumbers(totalPurchaseValue.toFixed(2)) + ' ريال';
      document.getElementById('total_selling_value').textContent = convertToLatinNumbers(totalSellingValue.toFixed(2)) + ' ريال';
      document.getElementById('total_expected_profit').textContent = convertToLatinNumbers(totalExpectedProfit.toFixed(2)) + ' ريال';


      // تحديث إحصائيات المبيعات
      const totalSales = sales.length;
      const totalSalesAmount = sales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
      const totalSalesSubtotal = sales.reduce((sum, sale) => sum + (sale.subtotal || 0), 0);
      const totalVatAmount = sales.reduce((sum, sale) => sum + (sale.vat_amount || 0), 0);

      // حساب الربح الفعلي: سعر البيع بعد الضريبة - سعر الشراء بعد الضريبة
      let totalActualProfit = 0;
      let totalPurchaseCostAfterTax = 0;
      
      sales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            // سعر البيع بعد الضريبة (من المبيعات)
            const sellingPriceAfterTax = item.unitPrice || item.unit_price || 0;
            const quantity = item.quantity || 1;
            const totalSellingPriceAfterTax = sellingPriceAfterTax * quantity;
            
            // سعر الشراء بعد الضريبة (من قاعدة البيانات)
            let purchasePriceAfterTax = 0;
            if (item.type === 'phone') {
              // البحث عن الهاتف في قاعدة البيانات
              const phone = phones.find(p => (p.id === item.id || p.phone_id === item.id || p.phone_number === item.id));
              if (phone) {
                purchasePriceAfterTax = (phone.purchase_price || 0) * 1.15; // إضافة 15% ضريبة
              }
            } else {
              // البحث عن الأكسسوار في قاعدة البيانات
              const accessory = accessories.find(a => (a.id === item.id || a.sku === item.id));
              if (accessory) {
                purchasePriceAfterTax = (accessory.purchase_price || 0) * 1.15; // إضافة 15% ضريبة
              }
            }
            
            const totalPurchasePriceAfterTax = purchasePriceAfterTax * quantity;
            const itemProfit = totalSellingPriceAfterTax - totalPurchasePriceAfterTax;
            
            totalActualProfit += itemProfit;
            totalPurchaseCostAfterTax += totalPurchasePriceAfterTax;
          });
        }
      });

      // حساب نسبة الربح الفعلية
      const actualProfitRatio = totalPurchaseCostAfterTax > 0 ? (totalActualProfit / totalPurchaseCostAfterTax) * 100 : 0;

      console.log('💰 إجمالي سعر البيع بعد الضريبة:', totalSalesAmount);
      console.log('💰 إجمالي سعر الشراء بعد الضريبة:', totalPurchaseCostAfterTax);
      console.log('💰 الربح الفعلي:', totalActualProfit);
      console.log('💰 نسبة الربح الفعلية:', actualProfitRatio.toFixed(2) + '%');

      document.getElementById('total_sales_count').textContent = convertToLatinNumbers(totalSales);
      document.getElementById('total_sales_amount').textContent = convertToLatinNumbers(totalSalesAmount.toFixed(0));
      document.getElementById('total_sales_subtotal').textContent = convertToLatinNumbers(totalSalesSubtotal.toFixed(2)) + ' ريال';
      document.getElementById('total_vat_amount').textContent = convertToLatinNumbers(totalVatAmount.toFixed(2)) + ' ريال';
      document.getElementById('total_actual_profit').textContent = convertToLatinNumbers(totalActualProfit.toFixed(2)) + ' ريال';

      // حساب نسبة الربح
      document.getElementById('profit_ratio').textContent = convertToLatinNumbers(actualProfitRatio.toFixed(1)) + '%';

      // تحديث آخر المبيعات
      updateRecentSales(sales);

    } catch (error) {
      console.error('خطأ في تحديث لوحة التحكم:', error);
    }
  }

  // تحديث قسم آخر المبيعات
  function updateRecentSales(sales) {
    const recentSalesContainer = document.getElementById('recent_sales_wrap');
    
    if (!sales || sales.length === 0) {
      recentSalesContainer.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">لا توجد مبيعات حديثة</h5>
        </div>
      `;
      return;
    }

    // ترتيب المبيعات حسب التاريخ (الأحدث أولاً) واختيار آخر 5
    const sortedSales = sales
      .sort((a, b) => {
        const dateA = getSaleDateValue(a) || new Date(0);
        const dateB = getSaleDateValue(b) || new Date(0);
        return dateB - dateA;
      })
      .slice(0, 5);

    let salesHTML = '';
    
    sortedSales.forEach(sale => {
      const saleDate = getSaleDateValue(sale) || new Date();
      const formattedDate = formatDate(saleDate);
      const customerName = sale.customer_name || 'عميل نقدي';
      const totalAmount = sale.total_amount || 0;
      const itemCount = sale.items ? sale.items.length : 0;
      const status = sale.status || 'مكتمل';
      
      // تحديد لون الحالة
      let statusBadge = 'bg-warning';
      if (status === 'مكتمل') statusBadge = 'bg-success';
      else if (status === 'ملغي') statusBadge = 'bg-danger';

      salesHTML += `
        <div class="row align-items-center py-2 border-bottom">
          <div class="col-md-2">
            <span class="badge bg-primary">${sale.sale_number || sale.id || 'غير محدد'}</span>
          </div>
          <div class="col-md-2">
            <small class="text-muted">${formattedDate}</small>
          </div>
          <div class="col-md-3">
            <strong>${customerName}</strong>
          </div>
          <div class="col-md-2">
            <span class="badge bg-info">${convertToLatinNumbers(itemCount)} منتج</span>
          </div>
          <div class="col-md-2">
            <strong class="text-success">${convertToLatinNumbers(totalAmount.toFixed(2))} ريال</strong>
          </div>
          <div class="col-md-1">
            <span class="badge ${statusBadge}">${status}</span>
          </div>
        </div>
      `;
    });

    recentSalesContainer.innerHTML = `
      <div class="table-responsive">
        <div class="row fw-bold text-muted border-bottom pb-2 mb-2">
          <div class="col-md-2">رقم العملية</div>
          <div class="col-md-2">التاريخ</div>
          <div class="col-md-3">العميل</div>
          <div class="col-md-2">المنتجات</div>
          <div class="col-md-2">المبلغ</div>
          <div class="col-md-1">الحالة</div>
        </div>
        ${salesHTML}
      </div>
      <div class="text-center mt-3">
        <a href="list_sales.html" class="btn btn-outline-success">
          <i class="fas fa-list"></i> عرض جميع المبيعات
        </a>
      </div>
    `;
  }

  // تنسيق التاريخ للعرض
  function formatDate(anyDate) {
    const d = normalizeToDate(anyDate);
    if (!d) return '-';
    
    try {
      const pad = x => String(x).padStart(2,'0');
      const year    = d.getFullYear();
      const month   = pad(d.getMonth() + 1);
      const day     = pad(d.getDate());
      const hours   = pad(d.getHours());
      const minutes = pad(d.getMinutes());
      
      return `${convertToLatinNumbers(year)}-${convertToLatinNumbers(month)}-${convertToLatinNumbers(day)} ${convertToLatinNumbers(hours)}:${convertToLatinNumbers(minutes)}`;
    } catch {
      return '-';
    }
  }

  // تهيئة الصفحة
  document.addEventListener('DOMContentLoaded', async function() {
    // التحقق من تسجيل الدخول أولاً
    if (!checkLogin()) return;

    // انتظار تحميل Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));

    // تحديث لوحة التحكم
    await updateDashboard();

    // تحديث البيانات كل 10 ثوانِ
    setInterval(async () => {
      await updateDashboard();
    }, 10000);
  });
</script>
</body>
</html>
