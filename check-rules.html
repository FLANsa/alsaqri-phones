<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Firestore Rules</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Firestore Security Rules Test</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>

    <script type="module" src="js/firebase-config.js"></script>
    <script type="module">
        import { doc, setDoc, getDoc, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            resultsDiv.appendChild(div);
            console.log(message);
        }

        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDB) {
                        log('‚úÖ Firestore loaded successfully', 'success');
                        resolve();
                    } else {
                        log('‚è≥ Waiting for Firestore...', 'info');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Test Firestore rules
        async function testFirestoreRules() {
            try {
                await waitForFirebase();
                statusDiv.textContent = 'Testing Firestore rules...';
                
                // Test 1: Try to write to test collection
                log('üìù Testing write to test collection...', 'info');
                try {
                    const testDoc = await addDoc(collection(window.firebaseDB, 'test'), {
                        message: 'Test write',
                        timestamp: new Date().toISOString()
                    });
                    log(`‚úÖ Write successful! Document ID: ${testDoc.id}`, 'success');
                } catch (writeError) {
                    log(`‚ùå Write failed: ${writeError.message}`, 'error');
                    log(`Error code: ${writeError.code}`, 'error');
                }
                
                // Test 2: Try to write to authorized_users collection
                log('üë§ Testing write to authorized_users collection...', 'info');
                try {
                    const userDoc = await addDoc(collection(window.firebaseDB, 'authorized_users'), {
                        email: 'test@example.com',
                        role: 'test',
                        name: 'Test User',
                        created_at: new Date().toISOString()
                    });
                    log(`‚úÖ Write to authorized_users successful! Document ID: ${userDoc.id}`, 'success');
                } catch (writeError) {
                    log(`‚ùå Write to authorized_users failed: ${writeError.message}`, 'error');
                    log(`Error code: ${writeError.code}`, 'error');
                }
                
                // Test 3: Try to read from authorized_users collection
                log('üìñ Testing read from authorized_users collection...', 'info');
                try {
                    const testDoc = await getDoc(doc(window.firebaseDB, 'authorized_users', 'test-user-id'));
                    if (testDoc.exists()) {
                        log('‚úÖ Read from authorized_users successful', 'success');
                    } else {
                        log('‚ö†Ô∏è Document not found (this is normal for test)', 'warning');
                    }
                } catch (readError) {
                    log(`‚ùå Read from authorized_users failed: ${readError.message}`, 'error');
                    log(`Error code: ${readError.code}`, 'error');
                }
                
                // Test 4: Try to write to phones collection
                log('üì± Testing write to phones collection...', 'info');
                try {
                    const phoneDoc = await addDoc(collection(window.firebaseDB, 'phones'), {
                        manufacturer: 'Test',
                        model: 'Test Phone',
                        condition: 'new',
                        created_at: new Date().toISOString()
                    });
                    log(`‚úÖ Write to phones successful! Document ID: ${phoneDoc.id}`, 'success');
                } catch (writeError) {
                    log(`‚ùå Write to phones failed: ${writeError.message}`, 'error');
                    log(`Error code: ${writeError.code}`, 'error');
                }
                
                // Test 5: Try to write to accessories collection
                log('üéß Testing write to accessories collection...', 'info');
                try {
                    const accessoryDoc = await addDoc(collection(window.firebaseDB, 'accessories'), {
                        name: 'Test Accessory',
                        category: 'test',
                        created_at: new Date().toISOString()
                    });
                    log(`‚úÖ Write to accessories successful! Document ID: ${accessoryDoc.id}`, 'success');
                } catch (writeError) {
                    log(`‚ùå Write to accessories failed: ${writeError.message}`, 'error');
                    log(`Error code: ${writeError.code}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Firestore rules test error: ${error.message}`, 'error');
                statusDiv.textContent = 'Firestore rules test failed';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', testFirestoreRules);
    </script>
</body>
</html>
