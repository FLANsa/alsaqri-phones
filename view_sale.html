<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تفاصيل عملية البيع — الصقري للاتصالات</title>

  <!-- نفس الخطوط/المكتبات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background:#f8f9fa; }
    .card { box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    /* قسيمة الطباعة (مخفية بالشاشة) */
    .receipt-template { display: none; }
    @media print {
      .container, .btn, .d-flex, .card { display:none !important; }
      .receipt-template {
        display:block !important; width:80mm !important; max-width:80mm !important;
        margin:0 auto !important; padding:5mm !important; font-family:'Courier New',monospace !important;
        font-size:12px !important; line-height:1.2 !important; color:#000 !important; background:#fff !important;
        page-break-inside: avoid !important;
      }
      .receipt-header{ text-align:center !important; margin-bottom:20px !important; border-bottom:1px dashed #000 !important; padding-bottom:15px !important; }
      .company-info h1{ font-size:18px !important; margin:0 0 10px !important; font-weight:bold !important; }
      .company-info p, .sale-info p, .customer-info p{ margin:3px 0 !important; font-size:11px !important; }
      .sale-info h2{ font-size:16px !important; margin:15px 0 10px !important; font-weight:bold !important; }
      .customer-info h3, .receipt-items h3{ font-size:14px !important; margin:15px 0 8px !important; font-weight:bold !important; text-align:center !important;}
      .items-table{ width:100% !important; border-collapse:collapse !important; font-size:10px !important; }
      .items-table th{ border-bottom:1px solid #000 !important; padding:5px 2px !important; text-align:center !important; font-weight:bold !important; }
      .items-table td{ padding:3px 2px !important; text-align:center !important; border-bottom:1px dotted #ccc !important; }
      .receipt-summary{ margin:20px 0 !important; border-top:1px dashed #000 !important; padding-top:15px !important; }
      .summary-row{ display:flex !important; justify-content:space-between !important; margin:8px 0 !important; font-size:12px !important; }
      .summary-row.total{ font-weight:bold !important; font-size:14px !important; border-top:1px solid #000 !important; padding-top:8px !important; margin-top:15px !important; }
      .receipt-footer{ text-align:center !important; margin-top:25px !important; border-top:1px dashed #000 !important; padding-top:15px !important; }
      .receipt-footer p{ margin:5px 0 !important; font-size:11px !important; }
      .receipt-header, .receipt-items, .receipt-summary, .receipt-footer{ page-break-inside:avoid !important; }
      @page{ size:80mm auto !important; margin:5mm !important; }
      *{ -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
    }
  </style>
</head>
<body>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-shopping-cart"></i> تفاصيل عملية البيع</h2>
    <div>
      <a href="list_sales.html" class="btn btn-secondary me-2">
        <i class="fas fa-arrow-left"></i> العودة لقائمة المبيعات
      </a>
      <a href="dashboard.html" class="btn btn-primary">
        <i class="fas fa-home"></i> لوحة التحكم
      </a>
    </div>
  </div>

  <!-- معلومات العملية -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-info-circle"></i> معلومات العملية</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless mb-0">
            <tr><td><strong>رقم العملية:</strong></td><td><span id="sale_number_badge" class="badge bg-primary fs-6">—</span></td></tr>
            <tr><td><strong>تاريخ الإنشاء:</strong></td><td id="sale_date">—</td></tr>
            <tr><td><strong>الحالة:</strong></td><td id="sale_status">—</td></tr>
            <tr><td><strong>طريقة الدفع:</strong></td><td id="sale_payment">—</td></tr>
          </table>
        </div>
      </div>
    </div>

    <!-- معلومات العميل -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-user"></i> معلومات العميل</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless mb-0">
            <tr><td><strong>اسم العميل:</strong></td><td id="cust_name">—</td></tr>
            <tr><td><strong>رقم الهاتف:</strong></td><td id="cust_phone">غير محدد</td></tr>
            <tr><td><strong>البريد الإلكتروني:</strong></td><td id="cust_email">غير محدد</td></tr>
            <tr><td><strong>العنوان:</strong></td><td id="cust_address">غير محدد</td></tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- المنتجات -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-box"></i> المنتجات المباعة</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle mb-0">
              <thead class="table-dark">
                <tr>
                  <th>نوع المنتج</th>
                  <th>اسم المنتج</th>
                  <th>الوصف</th>
                  <th>الرقم التسلسلي</th>
                  <th>سعر الوحدة</th>
                  <th>الكمية</th>
                  <th>السعر الإجمالي</th>
                </tr>
              </thead>
              <tbody id="items_tbody">
                <tr class="text-muted"><td colspan="7" class="text-center">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- الملخص المالي -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-calculator"></i> الملخص المالي</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4 text-center">
              <div class="border rounded p-3">
                <h6 class="text-muted">المجموع قبل الضريبة</h6>
                <h4 class="text-primary" id="sum_subtotal">0.00 ريال</h4>
              </div>
            </div>
            <div class="col-md-4 text-center">
              <div class="border rounded p-3">
                <h6 class="text-muted">مبلغ الضريبة (15%)</h6>
                <h4 class="text-warning" id="sum_vat">0.00 ريال</h4>
              </div>
            </div>
            <div class="col-md-4 text-center">
              <div class="border rounded p-3">
                <h6 class="text-muted">المبلغ الإجمالي</h6>
                <h4 class="text-success fw-bold" id="sum_total">0.00 ريال</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- الملاحظات (تظهر فقط إن وُجدت) -->
  <div id="notes_card" class="row mt-4 d-none">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-sticky-note"></i> الملاحظات</h5>
        </div>
        <div class="card-body">
          <p id="sale_notes" class="mb-0"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- أزرار الإجراءات -->
  <div class="row mt-4">
    <div class="col-md-12 text-center">
      <button class="btn btn-success btn-lg me-3" onclick="printReceipt()">
        <i class="fas fa-print"></i> طباعة الفاتورة
      </button>
      <a href="create_sale.html" class="btn btn-primary btn-lg">
        <i class="fas fa-plus"></i> إنشاء عملية بيع جديدة
      </a>
    </div>
  </div>
</div>

<!-- قالب القسيمة (يُملأ من JS ويظهر فقط عند الطباعة) -->
<div id="receipt-roll-template" class="receipt-template">
  <div class="receipt-header">
    <div class="company-info">
      <h1 id="rc_company_name">—</h1>
      <p>الرقم الضريبي: <span id="rc_company_vat">—</span></p>
      <p id="rc_company_address">—</p>
      <p>هاتف: <span id="rc_company_phone">—</span></p>
    </div>

    <div class="sale-info">
      <h2>فاتورة مبيعات</h2>
      <p>رقم العملية: <span id="rc_sale_num">—</span></p>
      <p>التاريخ: <span id="rc_sale_date">—</span></p>
      <p>طريقة الدفع: <span id="rc_payment">—</span></p>
    </div>

    <div id="rc_customer_block" class="customer-info" style="display:none;">
      <h3>معلومات العميل</h3>
      <p id="rc_cust_name" style="display:none;"></p>
      <p id="rc_cust_phone" style="display:none;"></p>
      <p id="rc_cust_address" style="display:none;"></p>
    </div>
  </div>

  <div class="receipt-items">
    <h3>المنتجات المباعة</h3>
    <table class="items-table" id="rc_items_table">
      <thead>
        <tr><th>المنتج</th><th>السعر</th><th>الكمية</th><th>المجموع</th></tr>
      </thead>
      <tbody id="rc_items_tbody"></tbody>
    </table>
  </div>

  <div class="receipt-summary">
    <div class="summary-row"><span>المجموع قبل الضريبة:</span><span id="rc_subtotal">0.00 ريال</span></div>
    <div class="summary-row"><span>الضريبة (15%):</span><span id="rc_vat">0.00 ريال</span></div>
    <div class="summary-row total"><span>المبلغ الإجمالي:</span><span id="rc_total">0.00 ريال</span></div>
  </div>

  <div class="receipt-footer">
    <p>شكراً لزيارتكم</p>
    <p>نتمنى لكم تجربة تسوق ممتعة</p>
    <p>تاريخ الطباعة: <span id="print-date">—</span></p>
  </div>
</div>

<!-- مكتبات JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- منطق الواجهة فقط -->
<script>
  // ==== بيانات تجريبية (واجهة فقط) — بدّلها لاحقاً ببيانات API ====
  const demoSale = {
    id: "S-1003",
    sale_number: "S-1003",
    date_created: "2025-09-01T14:20:00",
    status: "مكتمل",            // مكتمل | ملغي | معلق
    payment_method: "تحويل بنكي",
    customer_name: "شركة الواصل",
    customer_phone: "0555555555",
    customer_email: "contact@wasel.sa",
    customer_address: "الرياض - حي الملز",
    items: [
      { product_type:"phone", product_name:"Samsung S23", product_description:"256GB Black", serial_number:"SN456", unit_price:2200.00, quantity:1, total_price:2200.00 },
      { product_type:"accessory", product_name:"غطاء شفاف", product_description:"", serial_number:"", unit_price:165.00, quantity:2, total_price:330.00 }
    ],
    subtotal: 2530.00 - 379.50, // 2150.50
    vat_amount: 379.50,
    total_amount: 2530.00,
    notes: "تسليم خلال 24 ساعة",
    company_name: "الصقري للاتصالات",
    company_vat_number: "1234567890",
    company_address: "الرياض، المملكة العربية السعودية",
    company_phone: "011-0000000"
  };

  // قراءة بارامترات العنوان إن وُجدت (مثلاً ?id=...)
  function getQueryParams(){
    const p = new URLSearchParams(window.location.search);
    return Object.fromEntries(p.entries());
  }

  const fmtMoney = n => (Number(n)||0).toFixed(2);
  const formatDateTime = iso => {
    const d = new Date(iso);
    const pad = x => String(x).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  function badgeForStatus(status){
    let cls = 'bg-warning';
    if (status === 'مكتمل') cls = 'bg-success';
    else if (status === 'ملغي') cls = 'bg-danger';
    return `<span class="badge ${cls}">${status}</span>`;
  }

  function renderSale(sale){
    // رأس معلومات العملية
    document.getElementById('sale_number_badge').textContent = sale.sale_number || '—';
    document.getElementById('sale_date').textContent = sale.date_created ? formatDateTime(sale.date_created) : '—';
    document.getElementById('sale_status').innerHTML = badgeForStatus(sale.status || '-');
    document.getElementById('sale_payment').textContent = sale.payment_method || '—';

    // العميل
    document.getElementById('cust_name').textContent = sale.customer_name || 'عميل نقدي';
    document.getElementById('cust_phone').textContent = sale.customer_phone || 'غير محدد';
    document.getElementById('cust_email').textContent = sale.customer_email || 'غير محدد';
    document.getElementById('cust_address').textContent = sale.customer_address || 'غير محدد';

    // العناصر
    const tbody = document.getElementById('items_tbody');
    tbody.innerHTML = '';
    (sale.items || []).forEach(item => {
      const tr = document.createElement('tr');
      const typeBadge =
        item.product_type === 'phone' ? '<span class="badge bg-primary">هاتف</span>' :
        item.product_type === 'accessory' ? '<span class="badge bg-success">إكسسوار</span>' :
        item.product_type === 'charger' ? '<span class="badge bg-warning">شاحن</span>' :
        item.product_type === 'case' ? '<span class="badge bg-info">غلاف</span>' :
        item.product_type === 'screen_protector' ? '<span class="badge bg-secondary">حماية شاشة</span>' :
        `<span class="badge bg-dark">${item.product_type||'-'}</span>`;

      tr.innerHTML = `
        <td>${typeBadge}</td>
        <td>${item.product_name||'-'}</td>
        <td>${(item.product_description||'لا يوجد وصف') || '-'}</td>
        <td>${item.serial_number || 'لا يوجد'}</td>
        <td>${fmtMoney(item.unit_price)} ريال</td>
        <td>${item.quantity||0}</td>
        <td class="fw-bold text-success">${fmtMoney(item.total_price)} ريال</td>
      `;
      tbody.appendChild(tr);
    });

    // ملخص مالي
    document.getElementById('sum_subtotal').textContent = `${fmtMoney(sale.subtotal)} ريال`;
    document.getElementById('sum_vat').textContent = `${fmtMoney(sale.vat_amount)} ريال`;
    document.getElementById('sum_total').textContent = `${fmtMoney(sale.total_amount)} ريال`;

    // ملاحظات
    const notesCard = document.getElementById('notes_card');
    if (sale.notes && sale.notes.trim()){
      document.getElementById('sale_notes').textContent = sale.notes;
      notesCard.classList.remove('d-none');
    } else {
      notesCard.classList.add('d-none');
    }

    // تعبئة القسيمة للطباعة
    fillReceiptTemplate(sale);
  }

  function fillReceiptTemplate(sale){
    // الشركة
    document.getElementById('rc_company_name').textContent = sale.company_name || '';
    document.getElementById('rc_company_vat').textContent = sale.company_vat_number || '';
    document.getElementById('rc_company_address').textContent = sale.company_address || '';
    document.getElementById('rc_company_phone').textContent = sale.company_phone || '';

    // البيع
    document.getElementById('rc_sale_num').textContent = sale.sale_number || '';
    document.getElementById('rc_sale_date').textContent = sale.date_created ? formatDateTime(sale.date_created) : '';
    document.getElementById('rc_payment').textContent = sale.payment_method || '';

    // العميل (إظهار فقط إذا فيه بيانات مفيدة وليست "عميل نقدي")
    const showCustomer = (sale.customer_name && sale.customer_name !== 'عميل نقدي') || sale.customer_phone || sale.customer_address;
    const block = document.getElementById('rc_customer_block');
    block.style.display = showCustomer ? 'block' : 'none';

    const nameEl = document.getElementById('rc_cust_name');
    const phoneEl = document.getElementById('rc_cust_phone');
    const addrEl = document.getElementById('rc_cust_address');

    if (sale.customer_name && sale.customer_name !== 'عميل نقدي'){ nameEl.style.display='block'; nameEl.textContent = `الاسم: ${sale.customer_name}`; } else { nameEl.style.display='none'; }
    if (sale.customer_phone){ phoneEl.style.display='block'; phoneEl.textContent = `الهاتف: ${sale.customer_phone}`; } else { phoneEl.style.display='none'; }
    if (sale.customer_address){ addrEl.style.display='block'; addrEl.textContent = `العنوان: ${sale.customer_address}`; } else { addrEl.style.display='none'; }

    // العناصر
    const rcBody = document.getElementById('rc_items_tbody');
    rcBody.innerHTML = '';
    (sale.items || []).forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.product_name||'-'}</td>
        <td>${fmtMoney(it.unit_price)}</td>
        <td>${it.quantity||0}</td>
        <td>${fmtMoney(it.total_price)}</td>
      `;
      rcBody.appendChild(tr);
    });

    // المجاميع
    document.getElementById('rc_subtotal').textContent = `${fmtMoney(sale.subtotal)} ريال`;
    document.getElementById('rc_vat').textContent = `${fmtMoney(sale.vat_amount)} ريال`;
    document.getElementById('rc_total').textContent = `${fmtMoney(sale.total_amount)} ريال`;
  }

  function setPrintDate() {
    const now = new Date();
    document.getElementById('print-date').textContent = now.toLocaleString('ar-SA');
  }

  function printReceipt(){
    // نضبط تاريخ الطباعة ونستدعي نافذة الطباعة للصفحة الحالية (تُظهر القالب المطبوع فقط)
    setPrintDate();
    window.print();
  }

  // تهيئة
  document.addEventListener('DOMContentLoaded', () => {
    // في المستقبل: اجلب من API حسب ?id=...
    const qp = getQueryParams();
    // الآن نعرض البيانات التجريبية
    renderSale(demoSale);
  });
</script>
</body>
</html>
