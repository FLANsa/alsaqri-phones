<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>البحث في المخزون — تجربة النظام للاتصالات</title>

  <!-- نفس الخط/المكتبات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .table thead.table-dark th { vertical-align: middle; }
  </style>
</head>
<body>

  <!-- شريط التنقل -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">تجربة النظام للاتصالات</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

<div class="container mt-4">
  <!-- Simple Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-3">
        <i class="fas fa-search text-primary"></i> البحث في المخزون
      </h2>
    </div>
  </div>

  <!-- Simple Search Form -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <!-- واجهة فقط: لا إرسال لخادم -->
          <form id="searchForm" action="#" onsubmit="handleSearch(event)">
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="search_term" class="form-label">كلمة البحث</label>
                  <input type="text" class="form-control form-control-lg arabic-number-field" id="search_term" name="search_term"
                         placeholder="أدخل الباركود، الرقم التسلسلي، اسم المنتج...">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="search_type" class="form-label">نوع البحث</label>
                  <select class="form-select form-select-lg" id="search_type" name="search_type">
                    <option value="all">الكل</option>
                    <option value="phones">الهواتف</option>
                    <option value="accessories">الأكسسوارات</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary btn-lg px-4">
                <i class="fas fa-search"></i> بحث
              </button>
              <button type="button" class="btn btn-secondary btn-lg px-4 ms-2" onclick="loadAllData()">
                <i class="fas fa-list"></i> عرض الكل
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Results -->
  <div id="results_wrap" class="row mt-4 d-none">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-list"></i>
            نتائج البحث (<span id="results_count">0</span>)
          </h5>
        </div>
        <div class="card-body" id="results_body">
          <!-- يتم ملؤه ديناميكياً -->
        </div>
      </div>
    </div>
  </div>

</div>

<!-- مكتبات JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Integration -->
<script type="module" src="js/firebase-config-cdn.js"></script>
<script type="module" src="js/firebase-database-cdn.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- Firebase Search Integration -->
<script>
  // ===== متغيرات البيانات =====
  let allPhones = [];
  let allAccessories = [];
  let allSales = [];

  // ===== دعم الأرقام العربية =====
  function convertArabicToEnglishNumbers(str) {
    if (!str) return '';
    const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return str.toString().replace(/[٠-٩]/g, m => map[m] ?? m);
  }
  
  function parseArabicNumber(value) {
    if (!value || value.trim() === '') return 0;
    const converted = convertArabicToEnglishNumbers(value.toString());
    const num = parseFloat(converted);
    return isNaN(num) ? 0 : num;
  }
  
  function setupArabicNumberSupport() {
    document.querySelectorAll('.arabic-number-field').forEach(field => {
      field.addEventListener('input', function() {
        const pos = this.selectionStart;
        const cv = convertArabicToEnglishNumbers(this.value);
        if (cv !== this.value) {
          this.value = cv;
          this.setSelectionRange(pos, pos);
        }
      });
    });
  }

  // ===== الأدوات =====
  const fmtMoney = n => (Number(n)||0).toFixed(2);
  function includesAny(str, arr) {
    const s = (str || '').toString().toLowerCase();
    return arr.some(x => s.includes((x||'').toString().toLowerCase()));
  }

  // ===== هل الهاتف مباع؟ (نفس منطق صفحة المبيعات مع شوية مرونة في الحقول) =====
  function isPhoneSold(phoneId) {
    if (!phoneId) return false;
    if (!allSales || allSales.length === 0) return false;

    // استبعدنا العمليات المسترجعة
    const effectiveSales = allSales.filter(s => s && s.returned !== true && s.status !== 'مسترجعة');

    // ابحث عن هاتف ضمن items يطابق المعرّف
    return effectiveSales.some(sale =>
      Array.isArray(sale.items) &&
      sale.items.some(item => {
        const isPhoneType =
          item.type === 'phone' ||
          item.product_type === 'phone' ||
          item.type === 'هاتف';

        const candidateIds = [
          item.id,
          item.phone_id,
          item.barcode,
          item.phone_number,
          item.device_number,
          item.serial_number
        ].filter(Boolean).map(String);

        return isPhoneType && candidateIds.includes(String(phoneId));
      })
    );
  }


  // (تمت إزالة عناصر نوع البحث وحالة الهاتف من واجهة البحث)

  // ===== منطق البحث من قاعدة البيانات =====
  async function handleSearch(e){
    e.preventDefault();
    const term = (document.getElementById('search_term').value || '').trim();
    const type = document.getElementById('search_type').value || 'all';
    const statusFilter = 'all';

    console.log('🔍 البحث عن:', term, 'نوع:', type, 'حالة:', statusFilter);

    if (!term) {
      showAlert('warning', 'يرجى إدخال كلمة البحث');
      return;
    }

    try {
      // تحميل البيانات من Firebase أو localStorage
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('🔥 تحميل البيانات من Firebase للبحث...');
        allPhones = await window.storage.getPhones();
        allAccessories = await window.storage.getAccessories();
        allSales = await window.storage.getSales();
        console.log('📱 الهواتف المحملة:', allPhones);
        console.log('📦 الأكسسوارات المحملة:', allAccessories);
        console.log('🧾 المبيعات المحملة:', allSales);
      } else {
        console.log('💾 Firebase غير متاح، تحميل من localStorage...');
        allPhones = JSON.parse(localStorage.getItem('phones') || '[]');
        allAccessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        allSales = JSON.parse(localStorage.getItem('sales') || '[]');
        console.log('📱 الهواتف من localStorage:', allPhones);
        console.log('📦 الأكسسوارات من localStorage:', allAccessories);
        console.log('🧾 المبيعات من localStorage:', allSales);
      }

      // لم نعد نحتاج Set لأننا سنستخدم isPhoneSold مباشرة

      const tokens = term.toLowerCase().split(/\s+/);
      console.log('🔤 الرموز المطلوب البحث عنها:', tokens);

      let phones = [];
      let accessories = [];

      if (type === 'all' || type === 'phones') {
        phones = allPhones.filter(p => {
          
          // البحث في النص
          const searchText = `${p.phone_number || ''} ${p.manufacturer || p.brand || ''} ${p.model || ''} ${p.condition || p.phone_type || ''}`.toLowerCase();
          console.log('🔍 البحث في الهاتف:', p.phone_number, 'النص:', searchText, 'الحالة:', p.status || 'available');
          return tokens.some(token => searchText.includes(token));
        });
      }

      if (type === 'all' || type === 'accessories') {
        accessories = allAccessories.filter(a => {
          const searchText = `${a.name || ''} ${a.arabic_name || ''} ${a.category || ''}`.toLowerCase();
          console.log('🔍 البحث في الأكسسوار:', a.name || a.arabic_name, 'النص:', searchText);
          return tokens.some(token => searchText.includes(token));
        });
      }

      console.log('📊 نتائج البحث:', { phones: phones.length, accessories: accessories.length });
      console.log('📱 الهواتف المطابقة:', phones);
      console.log('📦 الأكسسوارات المطابقة:', accessories);
      renderResults(phones, accessories);

    } catch (error) {
      console.error('❌ خطأ في البحث:', error);
      showAlert('danger', 'حدث خطأ في البحث. حاول مرة أخرى.');
    }
  }

  // ===== العرض =====
  function renderResults(phones, accessories){
    const wrap = document.getElementById('results_wrap');
    const body = document.getElementById('results_body');
    const countEl = document.getElementById('results_count');

    const total = (phones?.length || 0) + (accessories?.length || 0);
    countEl.textContent = total;

    wrap.classList.remove('d-none');
    if (total === 0){
      body.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-search fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">لا توجد نتائج</h4>
          <p class="text-muted">لم يتم العثور على أي نتائج تطابق معايير البحث</p>
        </div>`;
      return;
    }

    let html = '';

    // Phones
    if (phones && phones.length){
      html += `
        <div class="mb-4">
          <h6 class="text-primary mb-3">
            <i class="fas fa-mobile-alt"></i> الهواتف (${phones.length})
          </h6>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>الباركود/رقم الجهاز</th>
                  <th>الشركة المصنعة</th>
                  <th>الموديل</th>
                  <th>الحالة</th>
                  <th>سعر الشراء</th>
                  <th>سعر البيع</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                ${phones.map(p => `
                  <tr>
                    <td><strong>${p.phone_number || p.device_number || 'غير محدد'}</strong></td>
                    <td>${p.manufacturer || p.brand || 'غير محدد'}</td>
                    <td>${p.model || 'غير محدد'}</td>
                    <td>
                      ${
                        (() => {
                          const pid = p.id || p.phone_number || p.device_number || p.serial_number;
                          return (pid && isPhoneSold(String(pid)))
                            ? '<span class="badge bg-danger">مباع</span>'
                            : '<span class="badge bg-success">متاح</span>';
                        })()
                      }
                    </td>
                    <td><span class="text-success">${fmtMoney(p.purchase_price || 0)} ريال</span></td>
                    <td><span class="text-primary">${fmtMoney(p.selling_price || p.price || 0)} ريال</span></td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewPhoneDetails('${p.phone_number || p.id}')" title="عرض التفاصيل">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editPhone('${p.phone_number || p.id}')" title="تعديل">
                          <i class="fas fa-edit"></i>
                        </button>
                        <!-- ✅ زر طباعة الباركود -->
                        <button type="button" class="btn btn-sm btn-outline-dark"
                                onclick="goPrintBarcode('${p.phone_number || p.device_number || p.serial_number || p.id}')"
                                title="طباعة الباركود">
                          <i class="fas fa-barcode"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    // Accessories
    if (accessories && accessories.length){
      html += `
        <div class="mb-4">
          <h6 class="text-success mb-3">
            <i class="fas fa-box"></i> الأكسسوارات (${accessories.length})
          </h6>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>الاسم</th>
                  <th>الفئة</th>
                  <th>الكمية</th>
                  <th>سعر الشراء</th>
                  <th>سعر البيع</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                ${accessories.map(a => `
                  <tr>
                    <td><strong>${a.arabic_name || a.name || 'غير محدد'}</strong></td>
                    <td><span class="badge bg-primary">${a.category || 'غير محدد'}</span></td>
                    <td><span class="badge bg-success">${a.quantity_in_stock || a.quantity || 0}</span></td>
                    <td><span class="text-success">${fmtMoney(a.purchase_price || 0)} ريال</span></td>
                    <td><span class="text-primary">${fmtMoney(a.selling_price || 0)} ريال</span></td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewAccessoryDetails('${a.id}')" title="عرض التفاصيل">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editAccessory('${a.id}')" title="تعديل">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccessory('${a.id}')" title="حذف">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    wrap.classList.remove('d-none');
    body.innerHTML = html;
  }

  // ===== دوال الإجراءات =====
  
  // عرض تفاصيل الهاتف
  function viewPhoneDetails(phoneNumber) {
    const phone = allPhones.find(p => p.phone_number === phoneNumber || p.id === phoneNumber);
    if (phone) {
      const details = `
رقم الجهاز: ${phone.phone_number || phone.device_number || 'غير محدد'}
الشركة المصنعة: ${phone.manufacturer || phone.brand || 'غير محدد'}
الموديل: ${phone.model || 'غير محدد'}
الحالة: ${phone.condition === 'new' || phone.phone_type === 'new' ? 'جديد' : 'مستعمل'}
سعر الشراء: ${fmtMoney(phone.purchase_price || 0)} ريال
سعر البيع: ${fmtMoney(phone.selling_price || phone.price || 0)} ريال
الربح: ${fmtMoney((phone.selling_price || phone.price || 0) - (phone.purchase_price || 0))} ريال
الذاكرة: ${phone.phone_memory || phone.memory || 'غير محدد'}
نسبة البطارية: ${phone.battery_level || phone.age || 'غير محدد'}
اللون: ${phone.phone_color || 'غير محدد'}
الرقم التسلسلي: ${phone.serial_number || 'غير محدد'}
الضمان: ${phone.warranty || 'غير محدد'} شهر
      `;
      alert(details);
    }
  }

  // تعديل الهاتف
  function editPhone(phoneNumber) {
    const phone = allPhones.find(p => p.phone_number === phoneNumber || p.id === phoneNumber);
    if (phone) {
      // توجيه إلى صفحة التعديل المخصصة
      window.location.href = `edit_phone.html?edit=${phoneNumber}`;
    }
  }

  // عرض تفاصيل الأكسسوار
  function viewAccessoryDetails(accessoryId) {
    const accessory = allAccessories.find(a => a.id === accessoryId);
    if (accessory) {
      const details = `
الاسم: ${accessory.arabic_name || accessory.name || 'غير محدد'}
الفئة: ${accessory.category || 'غير محدد'}
الكمية: ${accessory.quantity_in_stock || accessory.quantity || 0}
سعر الشراء: ${fmtMoney(accessory.purchase_price || 0)} ريال
سعر البيع: ${fmtMoney(accessory.selling_price || 0)} ريال
المورد: ${accessory.supplier || 'غير محدد'}
الوصف: ${accessory.description || 'لا يوجد وصف'}
      `;
      alert(details);
    }
  }

  // تعديل الأكسسوار
  function editAccessory(accessoryId) {
    window.location.href = `edit_accessory.html?id=${accessoryId}`;
  }

  // حذف الأكسسوار
  async function deleteAccessory(accessoryId) {
    const accessory = allAccessories.find(a => a.id === accessoryId);
    if (!accessory) return;

    if (!confirm(`هل أنت متأكد من حذف "${accessory.arabic_name || accessory.name}"؟`)) return;

    try {
      if (window.storage && window.storage.isFirebaseAvailable) {
        const success = await window.storage.deleteAccessory(accessoryId);
        if (success) {
          showAlert('success', 'تم حذف الأكسسوار بنجاح');
          // إعادة البحث لعرض النتائج المحدثة
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        } else {
          showAlert('danger', 'فشل في حذف الأكسسوار');
        }
      } else {
        showAlert('warning', 'Firebase غير متاح. لا يمكن حذف الأكسسوار.');
      }
    } catch (error) {
      console.error('❌ خطأ في حذف الأكسسوار:', error);
      showAlert('danger', 'حدث خطأ في حذف الأكسسوار');
    }
  }

  // عرض التنبيهات
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // التحقق من تسجيل الدخول
  function checkLogin() {
    const currentUser = localStorage.getItem('current_user');
    if (!currentUser) {
      alert('يجب تسجيل الدخول أولاً');
      window.location.href = 'login.html';
      return false;
    }
    return true;
  }

  // تسجيل الخروج
  function logout() {
    if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
      localStorage.removeItem('current_user');
      alert('تم تسجيل الخروج بنجاح');
      window.location.href = 'index.html';
    }
  }

  // ===== تحميل جميع البيانات عند فتح الصفحة =====
  async function loadAllData() {
    try {
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('🔥 تحميل جميع البيانات من Firebase...');
        allPhones = await window.storage.getPhones();
        allAccessories = await window.storage.getAccessories();
        allSales = await window.storage.getSales(); // ✅ مهم
        console.log('📱 جميع الهواتف:', allPhones);
        console.log('📦 جميع الأكسسوارات:', allAccessories);
        console.log('🧾 جميع المبيعات:', allSales);
      } else {
        console.log('💾 Firebase غير متاح، تحميل من localStorage...');
        allPhones = JSON.parse(localStorage.getItem('phones') || '[]');
        allAccessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        allSales = JSON.parse(localStorage.getItem('sales') || '[]'); // ✅ مهم
        console.log('📱 الهواتف من localStorage:', allPhones);
        console.log('📦 الأكسسوارات من localStorage:', allAccessories);
        console.log('🧾 المبيعات من localStorage:', allSales);
      }

      // عرض جميع البيانات (الـ isPhoneSold بتقرأ من allSales)
      renderResults(allPhones, allAccessories);
      
    } catch (error) {
      console.error('❌ خطأ في تحميل البيانات:', error);
      showAlert('danger', 'حدث خطأ في تحميل البيانات');
    }
  }

  // Check user role and update navigation
  function updateNavigationForUser() {
    const currentUser = localStorage.getItem('current_user');
    if (currentUser) {
      try {
        const userData = JSON.parse(currentUser);
        const navbar = document.querySelector('.navbar-nav.me-auto');
        
        if (userData.role === 'user') {
          // Show simplified navigation for limited users
          navbar.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="limited_dashboard.html"><i class="fas fa-home"></i> الرئيسية</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
          `;
        }
        // Admin users keep the full navigation (default)
      } catch (error) {
        console.error('Error parsing user data:', error);
      }
    }
  }

  // تهيئة الصفحة
  document.addEventListener('DOMContentLoaded', async function() {
    // Update navigation based on user role
    updateNavigationForUser();
    
    // إعداد دعم الأرقام العربية
    setupArabicNumberSupport();
    
    // التحقق من تسجيل الدخول أولاً
    if (!checkLogin()) return;

    // انتظار تهيئة Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (window.storage && window.storage.isFirebaseAvailable) {
      console.log('✅ Firebase متاح في صفحة البحث');
    } else {
      console.log('⚠️ Firebase غير متاح، استخدام localStorage');
    }
    
    // لا تُظهر النتائج افتراضياً — تُعرض فقط بعد البحث أو عند النقر على "عرض الكل"
  });

  // ===== طباعة الباركود =====
  function goPrintBarcode(rawCode) {
    const code = String(rawCode || '').trim();
    if (!code) { 
      showAlert('warning', 'لا يوجد رقم باركود صالح لهذا الجهاز'); 
      return; 
    }
    // ✅ نوجّه بنفس الشكل المطلوب
    window.location.href = `print_barcode.html?edit=${encodeURIComponent(code)}`;
  }
</script>

<!-- Navigation Script -->
<script src="js/navigation.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    initNavigation('search');
  });
</script>
</body>
</html>
