<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Firebase Connection Test</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>

    <script type="module" src="js/firebase-config.js"></script>
    <script type="module">
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            resultsDiv.appendChild(div);
            console.log(message);
        }

        // Wait for Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseAuth && window.firebaseDB) {
                        log('‚úÖ Firebase loaded successfully', 'success');
                        resolve();
                    } else {
                        log('‚è≥ Waiting for Firebase...', 'info');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                await waitForFirebase();
                statusDiv.textContent = 'Firebase ready!';
                
                // Test 1: Check if we can access Firebase Auth
                log('üîê Testing Firebase Auth...', 'info');
                log(`Auth instance: ${window.firebaseAuth}`, 'info');
                
                // Test 2: Check if we can access Firestore
                log('üìä Testing Firestore...', 'info');
                log(`Firestore instance: ${window.firebaseDB}`, 'info');
                
                // Test 3: Try to create a test document
                log('üìù Testing Firestore write...', 'info');
                try {
                    await setDoc(doc(window.firebaseDB, 'test', 'connection'), {
                        timestamp: new Date().toISOString(),
                        message: 'Connection test successful'
                    });
                    log('‚úÖ Firestore write successful', 'success');
                } catch (writeError) {
                    log(`‚ùå Firestore write failed: ${writeError.message}`, 'error');
                    log(`Error code: ${writeError.code}`, 'error');
                }
                
                // Test 4: Try to read the test document
                log('üìñ Testing Firestore read...', 'info');
                try {
                    const testDoc = await getDoc(doc(window.firebaseDB, 'test', 'connection'));
                    if (testDoc.exists()) {
                        log('‚úÖ Firestore read successful', 'success');
                        log(`Data: ${JSON.stringify(testDoc.data())}`, 'info');
                    } else {
                        log('‚ö†Ô∏è Test document not found', 'warning');
                    }
                } catch (readError) {
                    log(`‚ùå Firestore read failed: ${readError.message}`, 'error');
                }
                
                // Test 5: Check if users exist
                log('üë§ Testing user authentication...', 'info');
                try {
                    // Try to sign in with admin account
                    const adminCredential = await signInWithEmailAndPassword(window.firebaseAuth, 'admin@alsaqri.com', 'admin123');
                    log('‚úÖ Admin login successful', 'success');
                    log(`Admin UID: ${adminCredential.user.uid}`, 'info');
                    
                    // Check if user document exists
                    const adminDoc = await getDoc(doc(window.firebaseDB, 'authorized_users', adminCredential.user.uid));
                    if (adminDoc.exists()) {
                        log('‚úÖ Admin user document found', 'success');
                        log(`Admin data: ${JSON.stringify(adminDoc.data())}`, 'info');
                    } else {
                        log('‚ö†Ô∏è Admin user document not found in authorized_users', 'warning');
                    }
                    
                } catch (authError) {
                    log(`‚ùå Admin login failed: ${authError.message}`, 'error');
                    log(`Error code: ${authError.code}`, 'error');
                    
                    if (authError.code === 'auth/user-not-found') {
                        log('üí° User not found - need to create users first', 'warning');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Firebase connection error: ${error.message}`, 'error');
                statusDiv.textContent = 'Firebase connection failed';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', testFirebaseConnection);
    </script>
</body>
</html>
