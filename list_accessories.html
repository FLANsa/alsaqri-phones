<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مخزون الأكسسوارات — الصقري للاتصالات</title>

  <!-- نفس الخط/المكتبات المستخدمة -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .card-header { font-weight: 600; }
    .table thead.table-dark th { vertical-align: middle; }
  </style>
</head>
<body>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-box"></i> مخزون الأكسسوارات</h2>
    <div>
      <a href="add_accessory.html" class="btn btn-success me-2">
        <i class="fas fa-plus"></i> إضافة أكسسوار جديد
      </a>
      <a href="dashboard.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> العودة للوحة التحكم
      </a>
    </div>
  </div>

  <!-- سيتم إظهار الجدول أو الحالة الفارغة بحسب البيانات -->
  <div id="accessories_block" class="d-none">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">إجمالي الأكسسوارات: <span id="total_count">0</span></h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>الاسم</th>
                <th>الفئة</th>
                <th>الكمية</th>
                <th>سعر الشراء</th>
                <th>سعر البيع</th>
                <th>الربح المتوقع</th>
                <th>المورد</th>
                <th>تاريخ الإضافة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="accessories_tbody">
              <!-- تُملأ ديناميكياً -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- البطاقات التلخيصية -->
    <div class="row mt-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <h5 class="card-title">إجمالي الأكسسوارات</h5>
            <h3 id="sum_items">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <h5 class="card-title">إجمالي المخزون</h5>
            <h3 id="sum_qty">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body text-center">
            <h5 class="card-title">إجمالي قيمة الشراء</h5>
            <h3 id="sum_purchase">0.00 ريال</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body text-center">
            <h5 class="card-title">إجمالي قيمة البيع</h5>
            <h3 id="sum_selling">0.00 ريال</h3>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- حالة عدم وجود بيانات -->
  <div id="empty_state" class="text-center py-5 d-none">
    <i class="fas fa-box fa-5x text-muted mb-3"></i>
    <h4 class="text-muted">لا توجد أكسسوارات</h4>
    <p class="text-muted">لم يتم إضافة أي أكسسوارات بعد</p>
    <a href="add_accessory.html" class="btn btn-success btn-lg">
      <i class="fas fa-plus"></i> إضافة أكسسوار جديد
    </a>
  </div>
</div>

<!-- مكتبات JS نفسها -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- واجهة فقط: استبدال Jinja و fetch بخيارات محلية -->
<script>
  // خريطة عرض الفئات (بديل category_map من الخادم)
  const categoryMap = {
    case: "أغلفة",
    charger: "شواحن",
    screen_protector: "حماية الشاشة"
  };

  // بيانات تجريبية (واجهة فقط). لاحقًا اربطها بواجهة API فعلية.
  let accessories = [
    {
      id: 1,
      name: "غطاء شفاف",
      description: "سيليكون مرن",
      category: "case",
      quantity_in_stock: 20,
      purchase_price: 28.75,                // بدون/مع الضريبة حسب نظامك؛ هنا سنعرض مع/بدون كما في صفحتك
      purchase_price_with_vat: 33.06,
      selling_price: 51.75,
      selling_price_with_vat: 59.51,
      supplier: "XYZ للتوريد",
      date_added: "2025-01-12"
    },
    {
      id: 2,
      name: "شاحن 20W",
      description: "",
      category: "charger",
      quantity_in_stock: 15,
      purchase_price: 30.00,
      purchase_price_with_vat: 34.50,
      selling_price: 65.00,
      selling_price_with_vat: 74.75,
      supplier: "",
      date_added: "2025-02-05"
    }
  ];

  function formatMoney(n){ return (Number(n)||0).toFixed(2); }

  function render() {
    const hasData = accessories && accessories.length > 0;
    document.getElementById('accessories_block').classList.toggle('d-none', !hasData);
    document.getElementById('empty_state').classList.toggle('d-none', hasData);
    if (!hasData) return;

    // رأس البطاقة
    document.getElementById('total_count').textContent = accessories.length;

    // جسم الجدول
    const tbody = document.getElementById('accessories_tbody');
    tbody.innerHTML = '';
    let sumQty = 0, sumPurchase = 0, sumSelling = 0;

    accessories.forEach(acc => {
      sumQty += (acc.quantity_in_stock || 0);
      sumPurchase += (acc.purchase_price || 0);
      sumSelling += (acc.selling_price || 0);

      const tr = document.createElement('tr');

      // الاسم + الوصف
      const tdName = document.createElement('td');
      tdName.innerHTML = `<strong>${acc.name||''}</strong>` + 
        (acc.description ? `<br><small class="text-muted">${acc.description}</small>` : '');
      tr.appendChild(tdName);

      // الفئة (شارة)
      const tdCat = document.createElement('td');
      const catText = categoryMap[acc.category] || acc.category || '-';
      const catBadgeClass = categoryMap[acc.category] ? 'bg-primary' : 'bg-light text-dark';
      tdCat.innerHTML = `<span class="badge ${catBadgeClass}">${catText}</span>`;
      tr.appendChild(tdCat);

      // الكمية (شارة)
      const tdQty = document.createElement('td');
      tdQty.innerHTML = `<span class="badge bg-success">${acc.quantity_in_stock ?? 0}</span>`;
      tr.appendChild(tdQty);

      // سعر الشراء
      const tdBuy = document.createElement('td');
      tdBuy.innerHTML = `${formatMoney(acc.purchase_price)} ريال` +
        `<br><small class="text-muted">مع الضريبة: ${formatMoney(acc.purchase_price_with_vat||0)} ريال</small>`;
      tr.appendChild(tdBuy);

      // سعر البيع
      const tdSell = document.createElement('td');
      tdSell.innerHTML = `${formatMoney(acc.selling_price)} ريال` +
        `<br><small class="text-muted">مع الضريبة: ${formatMoney(acc.selling_price_with_vat||0)} ريال</small>`;
      tr.appendChild(tdSell);

      // الربح المتوقع + النسبة
      const tdProfit = document.createElement('td');
      const profit = (acc.selling_price||0) - (acc.purchase_price||0);
      const profitPct = (acc.purchase_price ? (profit / acc.purchase_price) * 100 : 0);
      tdProfit.innerHTML = `<span class="text-success fw-bold">${formatMoney(profit)} ريال</span>` +
        `<br><small class="text-muted">الربح: ${profitPct.toFixed(1)}%</small>`;
      tr.appendChild(tdProfit);

      // المورد
      const tdSupplier = document.createElement('td');
      tdSupplier.textContent = acc.supplier && acc.supplier.trim() ? acc.supplier : 'غير محدد';
      tr.appendChild(tdSupplier);

      // تاريخ الإضافة
      const tdDate = document.createElement('td');
      tdDate.textContent = acc.date_added || '-';
      tr.appendChild(tdDate);

      // الإجراءات (واجهة فقط)
      const tdActions = document.createElement('td');
      tdActions.innerHTML = `
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="editAccessory(${acc.id})" title="تعديل">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccessory(${acc.id})" title="حذف">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });

    // البطاقات التلخيصية السفلية
    document.getElementById('sum_items').textContent = accessories.length;
    document.getElementById('sum_qty').textContent = sumQty;
    document.getElementById('sum_purchase').textContent = `${formatMoney(sumPurchase)} ريال`;
    document.getElementById('sum_selling').textContent = `${formatMoney(sumSelling)} ريال`;
  }

  // بدائل للإجراءات الأصلية (بدون خادم)
  function editAccessory(accessoryId) {
    // بدلاً من /edit_accessory/<id> نقفز لصفحة ثابتة مع كويـري-سترينغ
    window.location.href = `edit_accessory.html?id=${encodeURIComponent(accessoryId)}`;
  }

  function deleteAccessory(accessoryId) {
    if (!confirm('هل أنت متأكد من حذف هذا الأكسسوار؟')) return;
    // واجهة فقط: حذف من المصفوفة محلياً
    accessories = accessories.filter(acc => acc.id !== accessoryId);
    alert('تم الحذف (واجهة فقط).');
    render();
  }

  // تهيئة
  document.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
