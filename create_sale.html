<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>إنشاء عملية بيع جديدة — الصقري للاتصالات</title>

  <!-- نفس الخط/المكتبات المستخدمة في القالب -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
  </style>
</head>
<body>

  <!-- شريط التنقل -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">الصقري للاتصالات</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="inventoryDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-boxes"></i> إدارة المخزون
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="inventory_summary.html"><i class="fas fa-chart-bar"></i> ملخص المخزون</a></li>
              <li><a class="dropdown-item" href="search.html"><i class="fas fa-search"></i> البحث في المخزون</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="add_accessory.html"><i class="fas fa-plus"></i> إضافة أكسسوار</a></li>
              <li><a class="dropdown-item" href="list_accessories_simple.html"><i class="fas fa-box"></i> مخزون الأكسسوارات</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="salesDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-shopping-cart"></i> إدارة المبيعات
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="list_sales.html"><i class="fas fa-list"></i> قائمة المبيعات</a></li>
              <li><a class="dropdown-item active" href="create_sale.html"><i class="fas fa-plus-circle"></i> إنشاء عملية بيع جديدة</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="phoneDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-mobile-alt"></i> إدارة الهواتف
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="add_new_phone.html"><i class="fas fa-mobile"></i> هاتف جديد</a></li>
              <li><a class="dropdown-item" href="add_used_phone.html"><i class="fas fa-mobile-alt"></i> هاتف مستعمل</a></li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- المحتوى الأصلي -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-shopping-cart"></i> إنشاء عملية بيع جديدة</h2>
      <a href="dashboard.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> العودة للوحة التحكم
      </a>
    </div>

    <div class="row">
      <!-- معلومات العميل -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user"></i> معلومات العميل</h5>
          </div>
          <div class="card-body">
            <form id="customerForm" action="#" onsubmit="return false;">
              <div class="mb-3">
                <label for="customer_name" class="form-label">اسم العميل</label>
                <input type="text" class="form-control" id="customer_name" name="customer_name">
              </div>
              <div class="mb-3">
                <label for="customer_phone" class="form-label">رقم الهاتف</label>
                <input type="tel" class="form-control" id="customer_phone" name="customer_phone">
              </div>
              <div class="mb-3">
                <label for="customer_email" class="form-label">البريد الإلكتروني</label>
                <input type="email" class="form-control" id="customer_email" name="customer_email">
              </div>
              <div class="mb-3">
                <label for="customer_address" class="form-label">العنوان</label>
                <textarea class="form-control" id="customer_address" name="customer_address" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label for="payment_method" class="form-label">طريقة الدفع</label>
                <select class="form-select" id="payment_method" name="payment_method">
                  <option value="نقدي">نقدي</option>
                  <option value="بطاقة ائتمان">بطاقة ائتمان</option>
                  <option value="تحويل بنكي">تحويل بنكي</option>
                  <option value="شيك">شيك</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="notes" class="form-label">ملاحظات</label>
                <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- اختيار المنتجات -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-box"></i> إضافة المنتجات</h5>
          </div>
          <div class="card-body">
            <!-- البحث بالباركود -->
            <div class="row mb-3">
              <div class="col-md-12">
                <label for="barcode_search" class="form-label">البحث بالباركود (اختياري)</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="barcode_search" placeholder="أدخل رقم الباركود للبحث السريع" onkeypress="if(event.key==='Enter') searchByBarcode()">
                  <button class="btn btn-outline-primary" type="button" onclick="searchByBarcode()">
                    <i class="fas fa-search"></i> بحث
                  </button>
                </div>
                <div id="barcode_search_result" class="mt-2" style="display: none;"></div>
              </div>
            </div>

            <!-- اختيار النوع والمنتج والكمية -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="product_type" class="form-label">نوع المنتج</label>
                <select class="form-select" id="product_type" onchange="loadProducts()">
                  <option value="">اختر نوع المنتج</option>
                  <option value="phone">هاتف</option>
                  <option value="accessory">إكسسوار</option>
                  <option value="charger">شاحن</option>
                  <option value="case">غلاف</option>
                  <option value="screen_protector">حماية الشاشة</option>
                  <option value="other">أخرى</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="product_select" class="form-label">المنتج</label>
                <select class="form-select" id="product_select" onchange="updateProductInfo()">
                  <option value="">اختر المنتج</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="quantity" class="form-label">الكمية</label>
                <input type="text" class="form-control arabic-number-field" id="quantity" value="1" onchange="updateTotalPrice()">
              </div>
            </div>

            <!-- تفاصيل المنتج -->
            <div id="product_details" class="mb-3" style="display: none;">
              <div class="card bg-light">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>اسم المنتج:</strong> <span id="selected_product_name">-</span></p>
                      <p><strong>الوصف:</strong> <span id="selected_product_description">-</span></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>السعر:</strong> <span id="selected_product_price">-</span> ريال</p>
                      <p><strong>السعر الإجمالي:</strong> <span id="total_price" class="text-success fw-bold">-</span> ريال</p>
                    </div>
                  </div>
                  <button type="button" class="btn btn-primary" onclick="addToCart()">
                    <i class="fas fa-plus"></i> إضافة للسلة
                  </button>
                </div>
              </div>
            </div>

            <!-- السلة -->
            <div class="card">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-shopping-cart"></i> سلة المشتريات</h6>
              </div>
              <div class="card-body">
                <div id="cart_items">
                  <p class="text-muted text-center">لا توجد منتجات في السلة</p>
                </div>

                <!-- الملخص -->
                <div id="cart_summary" style="display: none;">
                  <hr>
                  <div class="row">
                    <div class="col-md-6">
                      <h6>المجموع قبل الضريبة: <span id="cart_subtotal" class="text-primary">0.00</span> ريال</h6>
                      <h6>مبلغ الضريبة (15%): <span id="cart_vat" class="text-warning">0.00</span> ريال</h6>
                      <h5>المجموع الإجمالي: <span id="cart_total" class="text-success fw-bold">0.00</span> ريال</h5>
                    </div>
                    <div class="col-md-6 text-end">
                      <button type="button" class="btn btn-success btn-lg" onclick="completeSale()" id="complete_sale_btn" disabled>
                        <i class="fas fa-check"></i> إتمام عملية البيع
                      </button>
                    </div>
                  </div>
                </div>
                <!-- /الملخص -->
              </div>
            </div>

          </div>
        </div>
      </div>
      <!-- /اختيار المنتجات -->
    </div>
  </div>

  <!-- مكتبات JS نفسها -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Firebase Configuration -->
  <script type="module" src="js/firebase-config.js"></script>
  <script type="module" src="js/firebase-database.js"></script>
  <script type="module" src="js/firebase-storage-manager.js"></script>

  <!-- جافاسكربت واجهة فقط (بدل متغيرات Jinja وبدل fetch للخادم) -->
  <script>
    // بيانات المنتجات من Firebase
    let phones = [];
    let accessories = [];
    let accessoryCategories = [];
    let cart = [];

    // تهيئة Firebase عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', async () => {
      // انتظار تهيئة Firebase
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('✅ Firebase متاح في صفحة المبيعات');
        await loadDataFromFirebase();
      } else {
        console.log('⚠️ Firebase غير متاح، استخدام البيانات المحلية');
        await loadDataFromLocalStorage();
      }
    });

    // تحميل البيانات من Firebase
    async function loadDataFromFirebase() {
      try {
        phones = await window.storage.getPhones();
        accessories = await window.storage.getAccessories();
        accessoryCategories = await window.storage.getAccessoryCategories();
        sales = await window.storage.getSales();
        console.log('✅ تم تحميل البيانات من Firebase:', { phones: phones.length, accessories: accessories.length, categories: accessoryCategories.length, sales: sales.length });
        
        // تحديث قائمة أنواع المنتجات
        updateProductTypeDropdown();
      } catch (error) {
        console.error('❌ خطأ في تحميل البيانات من Firebase:', error);
        await loadDataFromLocalStorage();
      }
    }

    // تحميل البيانات من localStorage
    async function loadDataFromLocalStorage() {
      try {
        phones = JSON.parse(localStorage.getItem('phones') || '[]');
        accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        accessoryCategories = JSON.parse(localStorage.getItem('accessory_categories') || '[]');
        sales = JSON.parse(localStorage.getItem('sales') || '[]');
        console.log('💾 تم تحميل البيانات من localStorage:', { phones: phones.length, accessories: accessories.length, categories: accessoryCategories.length, sales: sales.length });
        
        // تحديث قائمة أنواع المنتجات
        updateProductTypeDropdown();
      } catch (error) {
        console.error('❌ خطأ في تحميل البيانات من localStorage:', error);
      }
    }

    // فحص ما إذا كان الهاتف تم بيعه
    function isPhoneSold(phoneId) {
      if (!sales || sales.length === 0) return false;
      
      return sales.some(sale => {
        if (!sale.items || !Array.isArray(sale.items)) return false;
        return sale.items.some(item => {
          return item.type === 'phone' && (item.id === phoneId || item.phone_id === phoneId);
        });
      });
    }

    // تحديث قائمة أنواع المنتجات من قاعدة البيانات
    function updateProductTypeDropdown() {
      const productTypeSelect = document.getElementById('product_type');
      
      // الحفاظ على الخيارات الأساسية
      productTypeSelect.innerHTML = `
        <option value="">اختر نوع المنتج</option>
        <option value="phone">هاتف</option>
      `;
      
      // إضافة فئات الأكسسوارات من قاعدة البيانات
      if (accessoryCategories && accessoryCategories.length > 0) {
        accessoryCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.name; // استخدام اسم الفئة كقيمة
          option.textContent = category.name; // عرض اسم الفئة
          productTypeSelect.appendChild(option);
        });
      } else {
        // إضافة الفئات الافتراضية إذا لم تكن متوفرة في قاعدة البيانات
        const defaultCategories = ['إكسسوار', 'شاحن', 'غلاف', 'حماية الشاشة', 'أخرى'];
        defaultCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          productTypeSelect.appendChild(option);
        });
      }
      
      console.log('✅ تم تحديث قائمة أنواع المنتجات:', accessoryCategories.length, 'فئة');
    }

    function loadProducts() {
      const productType = document.getElementById('product_type').value;
      const productSelect = document.getElementById('product_select');

      // تفريغ الاختيارات السابقة
      productSelect.innerHTML = '<option value="">اختر المنتج</option>';

      if (productType === 'phone') {
        // فلترة الهواتف غير المباعة
        const availablePhones = phones.filter(phone => {
          const phoneId = phone.id || phone.phone_number;
          return !isPhoneSold(phoneId);
        });
        
        if (availablePhones.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'لا توجد هواتف متاحة للبيع';
          option.disabled = true;
          productSelect.appendChild(option);
        } else {
          availablePhones.forEach(phone => {
            const option = document.createElement('option');
            option.value = phone.id || phone.phone_number;
            const manufacturer = phone.manufacturer || phone.brand;
            const model = phone.model;
            const barcode = phone.phone_number || phone.serial_number;
            option.textContent = `${manufacturer} ${model} - باركود: ${barcode}`;
            option.setAttribute('data-price', phone.selling_price);
            option.setAttribute('data-purchase-price', phone.purchase_price || 0);
            option.setAttribute('data-name', `${manufacturer} ${model}`);
            option.setAttribute('data-description', phone.description || '');
            option.setAttribute('data-barcode', barcode);
            productSelect.appendChild(option);
          });
        }
      } else {
        // فلترة الأكسسوارات المتاحة فقط (استبعاد التي لا يوجد منها مخزون)
        const availableAccessories = accessories.filter(acc => {
          const stock = acc.quantity_in_stock || acc.quantity || 0;
          return acc.category === productType && stock > 0;
        });
        
        if (availableAccessories.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'لا توجد أكسسوارات متاحة في هذه الفئة';
          option.disabled = true;
          productSelect.appendChild(option);
        } else {
          availableAccessories.forEach(acc => {
            const option = document.createElement('option');
            option.value = acc.id;
            const stock = acc.quantity_in_stock || acc.quantity || 0;
            
            // Use arabic_name if it exists and is different from name, otherwise use name
            const displayName = (acc.arabic_name && acc.arabic_name !== acc.name) ? acc.arabic_name : acc.name;
            
            option.textContent = `${displayName} (المخزون: ${stock})`;
            option.setAttribute('data-price', acc.selling_price || acc.price);
            option.setAttribute('data-purchase-price', acc.purchase_price || 0);
            option.setAttribute('data-name', displayName);
            option.setAttribute('data-description', acc.description || '');
            option.setAttribute('data-stock', stock);
            productSelect.appendChild(option);
          });
        }
      }
    }

    function updateProductInfo() {
      const productSelect = document.getElementById('product_select');
      const selectedOption = productSelect.options[productSelect.selectedIndex];

      if (selectedOption && selectedOption.value) {
        document.getElementById('selected_product_name').textContent = selectedOption.getAttribute('data-name');
        document.getElementById('selected_product_description').textContent = selectedOption.getAttribute('data-description');
        document.getElementById('selected_product_price').textContent = selectedOption.getAttribute('data-price');

        updateTotalPrice();
        document.getElementById('product_details').style.display = 'block';
      } else {
        document.getElementById('product_details').style.display = 'none';
      }
    }

    function updateTotalPrice() {
      const price = parseFloat(document.getElementById('selected_product_price').textContent) || 0;
      const quantity = parseArabicNumber(document.getElementById('quantity').value) || 1;
      const total = price * quantity;
      document.getElementById('total_price').textContent = total.toFixed(2);
    }

    // تحويل الأرقام العربية إلى إنجليزية
    function convertArabicToEnglishNumbers(str) {
      if (!str) return '';
      const arabicToEnglish = {
        '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
        '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
      };
      return str.toString().replace(/[٠-٩]/g, function(match) {
        return arabicToEnglish[match] || match;
      });
    }

    // تحويل قيمة وإرجاع رقم صحيح
    function parseArabicNumber(value) {
      if (!value || value.trim() === '') return 0;
      const convertedValue = convertArabicToEnglishNumbers(value.toString());
      const number = parseFloat(convertedValue);
      return isNaN(number) ? 0 : number;
    }

    function addToCart() {
      const productType = document.getElementById('product_type').value;
      const productSelect = document.getElementById('product_select');
      const quantity = parseArabicNumber(document.getElementById('quantity').value) || 1;

      if (!productType || !productSelect.value) {
        alert('يرجى اختيار نوع المنتج والمنتج');
        return;
      }

      const selectedOption = productSelect.options[productSelect.selectedIndex];
      
      // التحقق من المخزون للأكسسوارات
      if (productType !== 'phone') {
        const availableStock = parseInt(selectedOption.getAttribute('data-stock')) || 0;
        if (availableStock < quantity) {
          alert(`الكمية المطلوبة (${quantity}) أكبر من المخزون المتاح (${availableStock})`);
          return;
        }
      }
      
      const unitPrice = parseFloat(selectedOption.getAttribute('data-price'));
      const purchasePrice = parseFloat(selectedOption.getAttribute('data-purchase-price') || 0);
      const profit = unitPrice - purchasePrice;
      
      const product = {
        id: productSelect.value,
        type: productType,
        name: selectedOption.getAttribute('data-name'),
        description: selectedOption.getAttribute('data-description'),
        unitPrice: unitPrice,
        purchasePrice: purchasePrice,
        profit: profit,
        quantity: quantity,
        totalPrice: unitPrice * quantity,
        totalProfit: profit * quantity
      };

      cart.push(product);
      updateCartDisplay();

      // إعادة تعيين الحقول
      document.getElementById('product_type').value = '';
      document.getElementById('product_select').innerHTML = '<option value="">اختر المنتج</option>';
      document.getElementById('quantity').value = '1';
      document.getElementById('product_details').style.display = 'none';
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById('cart_items');
      const cartSummary = document.getElementById('cart_summary');

      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted text-center">لا توجد منتجات في السلة</p>';
        cartSummary.style.display = 'none';
        return;
      }

      let cartHTML = '<div class="table-responsive"><table class="table table-sm">';
      cartHTML += '<thead><tr><th>المنتج</th><th>سعر الشراء</th><th>سعر البيع</th><th>الربح</th><th>الكمية</th><th>المجموع</th><th>إجمالي الربح</th><th>الإجراء</th></tr></thead><tbody>';

      cart.forEach((item, index) => {
        cartHTML += `
          <tr>
            <td>${item.name}</td>
            <td>
              <span class="text-muted">${(item.purchasePrice || 0).toFixed(2)} ريال</span>
            </td>
            <td>
              <div class="input-group input-group-sm">
                <input type="number" class="form-control" id="price_${index}" 
                       value="${item.unitPrice.toFixed(2)}" 
                       step="0.01" min="0" 
                       onchange="updateItemPrice(${index})"
                       style="width: 80px;">
                <span class="input-group-text">ريال</span>
              </div>
            </td>
            <td>
              <span class="text-success fw-bold">${(item.profit || 0).toFixed(2)} ريال</span>
            </td>
            <td>
              <div class="input-group input-group-sm">
                <input type="number" class="form-control" id="quantity_${index}" 
                       value="${item.quantity}" 
                       min="1" 
                       onchange="updateItemQuantity(${index})"
                       style="width: 60px;">
              </div>
            </td>
            <td>${item.totalPrice.toFixed(2)} ريال</td>
            <td>
              <span class="text-success fw-bold">${(item.totalProfit || 0).toFixed(2)} ريال</span>
            </td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });

      cartHTML += '</tbody></table></div>';
      cartItems.innerHTML = cartHTML;

      updateCartSummary();
      cartSummary.style.display = 'block';
    }

    function updateCartSummary() {
      // حساب المجموع قبل الضريبة (الأسعار المدخلة تحتوي على الضريبة)
      const totalWithVAT = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      
      // حساب المبلغ قبل الضريبة (قسمة على 1.15)
      const subtotal = totalWithVAT / 1.15;
      
      // حساب مبلغ الضريبة (15%)
      const vat = totalWithVAT - subtotal;
      
      // المجموع الإجمالي (نفس totalWithVAT)
      const total = totalWithVAT;
      
      // حساب إجمالي الربح
      const totalProfit = cart.reduce((sum, item) => sum + (item.totalProfit || 0), 0);
      
      // حساب إجمالي سعر الشراء
      const totalPurchaseCost = cart.reduce((sum, item) => sum + ((item.purchasePrice || 0) * item.quantity), 0);

      document.getElementById('cart_subtotal').textContent = subtotal.toFixed(2);
      document.getElementById('cart_vat').textContent = vat.toFixed(2);
      document.getElementById('cart_total').textContent = total.toFixed(2);
      
      // إضافة معلومات الربح إذا كانت متوفرة
      const profitElement = document.getElementById('cart_profit');
      if (profitElement) {
        profitElement.textContent = totalProfit.toFixed(2);
      } else {
        // إنشاء عنصر الربح إذا لم يكن موجوداً
        const cartSummary = document.getElementById('cart_summary');
        const profitRow = document.createElement('div');
        profitRow.className = 'row mb-2';
        profitRow.innerHTML = `
          <div class="col-6">
            <strong>إجمالي سعر الشراء:</strong>
          </div>
          <div class="col-6 text-end">
            <span id="cart_purchase_cost" class="text-muted">${totalPurchaseCost.toFixed(2)} ريال</span>
          </div>
        `;
        const profitRow2 = document.createElement('div');
        profitRow2.className = 'row mb-2';
        profitRow2.innerHTML = `
          <div class="col-6">
            <strong>إجمالي الربح المتوقع:</strong>
          </div>
          <div class="col-6 text-end">
            <span id="cart_profit" class="text-success fw-bold">${totalProfit.toFixed(2)} ريال</span>
          </div>
        `;
        cartSummary.insertBefore(profitRow, cartSummary.querySelector('.row:last-child'));
        cartSummary.insertBefore(profitRow2, cartSummary.querySelector('.row:last-child'));
      } else {
        // تحديث القيم الموجودة
        const purchaseCostElement = document.getElementById('cart_purchase_cost');
        if (purchaseCostElement) {
          purchaseCostElement.textContent = totalPurchaseCost.toFixed(2) + ' ريال';
        }
        document.getElementById('cart_profit').textContent = totalProfit.toFixed(2);
      }

      document.getElementById('complete_sale_btn').disabled = cart.length === 0;
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }

    function updateItemPrice(index) {
      const newPrice = parseFloat(document.getElementById(`price_${index}`).value) || 0;
      if (newPrice < 0) {
        alert('السعر لا يمكن أن يكون سالباً');
        document.getElementById(`price_${index}`).value = cart[index].unitPrice.toFixed(2);
        return;
      }
      
      cart[index].unitPrice = newPrice;
      cart[index].profit = newPrice - cart[index].purchasePrice;
      cart[index].totalPrice = newPrice * cart[index].quantity;
      cart[index].totalProfit = cart[index].profit * cart[index].quantity;
      updateCartDisplay();
    }

    function updateItemQuantity(index) {
      const newQuantity = parseInt(document.getElementById(`quantity_${index}`).value) || 1;
      if (newQuantity < 1) {
        alert('الكمية يجب أن تكون 1 أو أكثر');
        document.getElementById(`quantity_${index}`).value = cart[index].quantity;
        return;
      }
      
      // التحقق من المخزون للأكسسوارات
      if (cart[index].type !== 'phone') {
        const selectedOption = document.querySelector(`option[data-id="${cart[index].id}"]`);
        if (selectedOption) {
          const availableStock = parseInt(selectedOption.getAttribute('data-stock')) || 0;
          if (availableStock < newQuantity) {
            alert(`الكمية المطلوبة (${newQuantity}) أكبر من المخزون المتاح (${availableStock})`);
            document.getElementById(`quantity_${index}`).value = cart[index].quantity;
            return;
          }
        }
      }
      
      cart[index].quantity = newQuantity;
      cart[index].totalPrice = cart[index].unitPrice * newQuantity;
      cart[index].totalProfit = cart[index].profit * newQuantity;
      updateCartDisplay();
    }

    // البحث بالباركود
    function searchByBarcode() {
      const barcode = document.getElementById('barcode_search').value.trim();
      const resultDiv = document.getElementById('barcode_search_result');
      
      if (!barcode) {
        resultDiv.style.display = 'none';
        return;
      }

        // البحث في الهواتف غير المباعة
        const foundPhone = phones.find(phone => {
          const phoneBarcode = phone.phone_number || phone.serial_number;
          const phoneId = phone.id || phone.phone_number;
          return phoneBarcode && phoneBarcode.toString() === barcode && !isPhoneSold(phoneId);
        });

      if (foundPhone) {
        const manufacturer = foundPhone.manufacturer || foundPhone.brand;
        const model = foundPhone.model;
        const price = foundPhone.selling_price;
        const purchasePrice = foundPhone.purchase_price || 0;
        const profit = price - purchasePrice;
        
        resultDiv.innerHTML = `
          <div class="alert alert-success">
            <h6><i class="fas fa-mobile-alt"></i> تم العثور على الهاتف:</h6>
            <p><strong>${manufacturer} ${model}</strong></p>
            <p>الباركود: ${barcode} | السعر: ${price} ريال | سعر الشراء: ${purchasePrice} ريال | الربح: ${profit.toFixed(2)} ريال</p>
            <button class="btn btn-sm btn-primary" onclick="selectPhoneByBarcode('${foundPhone.id || foundPhone.phone_number}')">
              <i class="fas fa-plus"></i> إضافة للسلة
            </button>
          </div>
        `;
        resultDiv.style.display = 'block';
      } else {
        // التحقق من وجود الهاتف في القائمة الكاملة (مباع أم لا)
        const allPhones = phones.find(phone => {
          const phoneBarcode = phone.phone_number || phone.serial_number;
          return phoneBarcode && phoneBarcode.toString() === barcode;
        });
        
        if (allPhones && isPhoneSold(allPhones.id || allPhones.phone_number)) {
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-times-circle"></i> هذا الهاتف تم بيعه مسبقاً ولا يمكن بيعه مرة أخرى
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i> لم يتم العثور على هاتف بالباركود: ${barcode}
            </div>
          `;
        }
        resultDiv.style.display = 'block';
      }
    }

    // اختيار الهاتف بالباركود
    function selectPhoneByBarcode(phoneId) {
      const foundPhone = phones.find(phone => (phone.id || phone.phone_number) === phoneId);
      if (!foundPhone) return;

      const manufacturer = foundPhone.manufacturer || foundPhone.brand;
      const model = foundPhone.model;
      const barcode = foundPhone.phone_number || foundPhone.serial_number;
      const sellingPrice = parseFloat(foundPhone.selling_price);
      const purchasePrice = parseFloat(foundPhone.purchase_price || 0);
      const profit = sellingPrice - purchasePrice;
      
      // إضافة مباشرة للسلة
      const product = {
        id: phoneId,
        type: 'phone',
        name: `${manufacturer} ${model}`,
        description: foundPhone.description || '',
        unitPrice: sellingPrice,
        purchasePrice: purchasePrice,
        profit: profit,
        quantity: 1,
        totalPrice: sellingPrice,
        totalProfit: profit
      };

      cart.push(product);
      updateCartDisplay();
      
      // إخفاء نتيجة البحث
      document.getElementById('barcode_search_result').style.display = 'none';
      document.getElementById('barcode_search').value = '';
      
      // إظهار رسالة نجاح مع معلومات الربح
      alert(`تم إضافة ${manufacturer} ${model} (باركود: ${barcode}) للسلة بنجاح!\nسعر البيع: ${sellingPrice} ريال\nسعر الشراء: ${purchasePrice} ريال\nالربح: ${profit.toFixed(2)} ريال`);
    }

    // إعداد دعم الأرقام العربية
    function setupArabicNumberSupport() {
      const numberFields = document.querySelectorAll('.arabic-number-field');
      
      numberFields.forEach(field => {
        field.addEventListener('input', function() {
          const cursorPosition = this.selectionStart;
          const originalValue = this.value;
          const convertedValue = convertArabicToEnglishNumbers(originalValue);
          
          if (convertedValue !== originalValue) {
            this.value = convertedValue;
            this.setSelectionRange(cursorPosition, cursorPosition);
          }
        });
      });
    }


    // بدل الاتصال بالخادم — نعرض رسالة فقط ونطبع البيانات في الـ Console
    async function completeSale() {
      if (cart.length === 0) {
        alert('السلة فارغة');
        return;
      }

      // حساب المجاميع الصحيحة
      const totalWithVAT = cart.reduce((sum, item) => sum + item.totalPrice, 0);
      const subtotal = totalWithVAT / 1.15;
      const vat = totalWithVAT - subtotal;

      // إنشاء رقم عملية البيع
      const saleNumber = 'SALE-' + Date.now().toString().slice(-6);

      // حساب إجمالي الربح وسعر الشراء
      const totalProfit = cart.reduce((sum, item) => sum + (item.totalProfit || 0), 0);
      const totalPurchaseCost = cart.reduce((sum, item) => sum + ((item.purchasePrice || 0) * item.quantity), 0);

      const saleData = {
        sale_number: saleNumber,
        customer_name: document.getElementById('customer_name').value.trim() || 'عميل نقدي',
        customer_phone: document.getElementById('customer_phone').value.trim() || '',
        customer_email: document.getElementById('customer_email').value,
        customer_address: document.getElementById('customer_address').value,
        payment_method: document.getElementById('payment_method').value,
        notes: document.getElementById('notes').value,
        items: cart,
        subtotal: subtotal,
        vat_amount: vat,
        total_amount: totalWithVAT,
        total_purchase_cost: totalPurchaseCost,
        total_profit: totalProfit,
        status: 'مكتمل',
        date_created: new Date().toISOString(),
        date_added: new Date().toISOString()
      };

      console.log('بيانات البيع:', saleData);

      try {
        // حفظ البيع في قاعدة البيانات
        if (window.storage && window.storage.isFirebaseAvailable) {
          console.log('🔥 حفظ البيع في Firebase...');
          const saleId = await window.storage.addSale(saleData);
          if (saleId) {
            console.log('✅ تم حفظ البيع في Firebase بنجاح! ID:', saleId);
            saleData.id = saleId;
          } else {
            console.log('❌ فشل في حفظ البيع في Firebase');
            throw new Error('فشل في حفظ البيع في قاعدة البيانات');
          }
        } else {
          // حفظ في localStorage كبديل
          console.log('💾 حفظ البيع في localStorage...');
          const sales = JSON.parse(localStorage.getItem('sales') || '[]');
          saleData.id = Date.now().toString();
          sales.push(saleData);
          localStorage.setItem('sales', JSON.stringify(sales));
          console.log('✅ تم حفظ البيع في localStorage');
        }


        // حفظ آخر عملية بيع للعرض السريع
        localStorage.setItem('lastSale', JSON.stringify(saleData));

        // عرض رسالة النجاح
        alert(`تم إنشاء عملية البيع بنجاح!\n\nرقم العملية: ${saleNumber}\nالمجموع قبل الضريبة: ${subtotal.toFixed(2)} ريال\nالضريبة (15%): ${vat.toFixed(2)} ريال\nالمجموع الإجمالي: ${totalWithVAT.toFixed(2)} ريال\nإجمالي سعر الشراء: ${totalPurchaseCost.toFixed(2)} ريال\nإجمالي الربح المتوقع: ${totalProfit.toFixed(2)} ريال`);
        
        // مسح السلة بعد إتمام البيع
        cart = [];
        updateCartDisplay();
        
        // إعادة تعيين النموذج
        document.querySelector('form').reset();
        
        // توجيه إلى صفحة عرض البيع
        setTimeout(() => {
          window.location.href = `view_sale.html?id=${saleData.id}`;
        }, 1000);

      } catch (error) {
        console.error('❌ خطأ في حفظ البيع:', error);
        alert('حدث خطأ في حفظ عملية البيع. يرجى المحاولة مرة أخرى.');
      }
    }

    // تسجيل الخروج
    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        localStorage.removeItem('current_user');
        alert('تم تسجيل الخروج بنجاح');
        window.location.href = 'index.html';
      }
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      setupArabicNumberSupport();
    });
  </script>
</body>
</html>
