<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>طباعة الباركود — الصقري للاتصالات</title>

  <!-- خطوط وستايل عام -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- مكتبات التصدير -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="js/arabic-font.js"></script>

  <style>
    :root { --card-bg: #ffffff; --muted:#cfcfcf; }
    body { font-family: 'Cairo', sans-serif; background:#f8f9fa; margin:0; padding:24px; }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: var(--card-bg);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display:flex; align-items:center; justify-content:space-between;
    }
    .card-header h3 { margin:0; font-size: 1.1rem; font-weight: 700; }
    .card-body { padding: 20px; }

    /* معاينة داخل إطار منقط */
    .sticker-preview{
      border:2px dashed var(--muted);
      padding:20px;
      background:#f9f9f9;
      border-radius:10px;
      display:flex;
      justify-content:center;
      margin-bottom: 18px;
    }

    /* حجم الملصق للمعاينة: 6cm × 3cm (أكبر قليلاً لراحة القراءة) */
    .sticker{
      width:6cm;
      height:3cm;
      background:#fff;
      border:1px solid #ddd;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      padding:0.2cm;
      gap:0.15cm;
    }

    /* اسم الشركة */
    .shop{
      text-align:center;
      font-weight:700;
      font-size:4mm; /* مقروء */
      line-height:1.1;
      margin-bottom:0.1cm;
    }

    /* الباركود في الوسط */
    .sticker-barcode{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:-0.05cm 0 0 0; /* رفع الباركود أكثر */
    }
    .sticker-barcode img{
      width:95%; /* تكبير الباركود في العرض */
      height:auto;
      max-height:0.8cm; /* تقصير الباركود (تقليل الارتفاع) */
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      display:block;
    }

    /* تفاصيل الجهاز بالأسفل: 3 أعمدة */
    .rows{ 
      display:flex; 
      flex-direction:row; 
      gap:0.1cm; 
      justify-content:space-between;
      margin-top: -0.35cm; /* رفع العناصر قليلاً أكثر */
    }
    .row2{
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:2.5mm;
      line-height:1.05;
      text-align:center;
      width: 33.333%;
    }
    .label{ color:#222; font-weight:600; text-align:center; }
    .value{ color:#000; font-weight:700; text-align:center; }

    /* أزرار */
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn {
      appearance:none; border:0; padding:10px 14px; border-radius:10px; cursor:pointer;
      font-weight:700; font-family:inherit;
    }
    .btn-primary { background:#10b981; color:#fff; }
    .btn-outline { background:#fff; color:#111; border:1px solid #e5e7eb; }
    .btn i { margin-left:8px; }

    /* طباعة المتصفح (للزر "طباعة PDF") — سنحوّل إلى PDF أولاً ثم نطبع */
    @page{ size:auto; margin:5mm; }
    @media print{
      .no-print { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h3>طباعة باركود الهاتف</h3>
        <div class="actions no-print">
          <button id="btnDownloadPDF" class="btn btn-primary">
            تحميل PDF <i class="fa fa-download"></i>
          </button>
          <button id="btnPrintPDF" class="btn btn-outline">
            طباعة PDF <i class="fa fa-print"></i>
          </button>
          <a href="dashboard.html" class="btn btn-outline">العودة للوحة التحكم</a>
        </div>
      </div>
      <div class="card-body">
        <div class="sticker-preview">
          <!-- الملصق الحقيقي (سيتم تصويره وتحويله إلى PDF) -->
          <div id="sticker" class="sticker">
            <!-- اسم الشركة -->
            <div class="shop">الصقري للاتصالات</div>

            <!-- الباركود -->
            <div class="sticker-barcode">
              <canvas id="barcode-canvas"></canvas>
            </div>

            <!-- التفاصيل -->
            <div class="rows">
              <div class="row2">
                <div class="label">رقم الجهاز</div>
                <div class="value" id="phone-number">-</div>
              </div>
              <div class="row2">
                <div class="label">نسبة البطارية</div>
                <div class="value" id="battery-level">-</div>
              </div>
              <div class="row2">
                <div class="label">الذاكرة</div>
                <div class="value" id="phone-memory">-</div>
              </div>
            </div>
          </div><!-- /sticker -->
        </div><!-- /preview -->
      </div>
    </div>
  </div>

  <script>
    (function () {
      // إعدادات الملصق النهائي على PDF: 40×25 ملم
      const STICKER_MM = { w: 40, h: 25 };
      const DPI = 300;                            // دقة ممتازة للطباعة
      const PX_PER_MM = DPI / 25.4;
      const TARGET_W = Math.round(STICKER_MM.w * PX_PER_MM);
      const TARGET_H = Math.round(STICKER_MM.h * PX_PER_MM);

      const stickerEl = document.getElementById('sticker');
      const btnDownload = document.getElementById('btnDownloadPDF');
      const btnPrint = document.getElementById('btnPrintPDF');

      if (!stickerEl) {
        console.error('Sticker element not found!');
        return;
      }

      // جلب بيانات الهاتف من URL أو Firebase
      async function loadPhoneData() {
        try {
          // محاولة جلب رقم الهاتف من URL
          const urlParams = new URLSearchParams(window.location.search);
          const phoneNumber = urlParams.get('phone_number');
          
          if (phoneNumber && window.storage) {
            // البحث عن الهاتف في Firebase
            const phones = await window.storage.getPhones();
            const phone = phones.find(p => p.phone_number === phoneNumber);
            
            if (phone) {
              // تحديث البيانات في الواجهة
              document.getElementById('phone-number').textContent = phone.phone_number || '-';
              document.getElementById('battery-level').textContent = phone.battery_level || '100';
              document.getElementById('phone-memory').textContent = phone.phone_memory || '32GB';
              
              // توليد الباركود
              generateBarcode(phone.phone_number || '1');
              return;
            }
          }
          
          // إذا لم يتم العثور على البيانات، استخدم القيم الافتراضية
          const defaultNumber = phoneNumber || '1';
          document.getElementById('phone-number').textContent = defaultNumber;
          document.getElementById('battery-level').textContent = '100';
          document.getElementById('phone-memory').textContent = '32GB';
          
          // توليد الباركود
          generateBarcode(defaultNumber);
          
        } catch (error) {
          console.error('خطأ في جلب بيانات الهاتف:', error);
          // استخدام القيم الافتراضية في حالة الخطأ
          document.getElementById('phone-number').textContent = '1';
          document.getElementById('battery-level').textContent = '100';
          document.getElementById('phone-memory').textContent = '32GB';
          generateBarcode('1');
        }
      }

      // توليد الباركود
      function generateBarcode(phoneNumber) {
        try {
          const canvas = document.getElementById('barcode-canvas');
          if (canvas && window.JsBarcode) {
            JsBarcode(canvas, phoneNumber, {
              format: "CODE128",
              width: 3, /* تكبير عرض الخطوط أكثر */
              height: 30, /* تقصير ارتفاع الباركود */
              displayValue: false,
              background: "#ffffff",
              lineColor: "#000000"
            });
          }
        } catch (error) {
          console.error('خطأ في توليد الباركود:', error);
        }
      }

      // نلتقط الملصق كصورة عالية الدقة (Canvas) عبر html2canvas
      async function captureStickerCanvas() {
        // نجعل الناتج يطابق أبعاد PDF بالبكسل (حتى لو المعاينة 6×3 سم)
        const scaleX = TARGET_W / stickerEl.clientWidth;
        const scaleY = TARGET_H / stickerEl.clientHeight;
        const scale = Math.min(scaleX, scaleY);

        return await html2canvas(stickerEl, {
          backgroundColor: '#ffffff',
          scale: scale,         // يرفع الدقة
          useCORS: true,        // للسماح بتحميل صور من نفس الأصل
          logging: false
        });
      }

      // نصدر PDF بحجم 40×25 مم
      async function exportPdfBlobUrl() {
        const canvas = await captureStickerCanvas();
        const imgData = canvas.toDataURL('image/png');

        // نستخدم jsPDF بأبعاد الملصق (Landscape لأن العرض أكبر)
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: [STICKER_MM.w, STICKER_MM.h]
        });

        // نضيف الصورة لتملأ الصفحة بالكامل
        doc.addImage(imgData, 'PNG', 0, 0, STICKER_MM.w, STICKER_MM.h);

        // نُعيد Blob URL لاستخدامه للتحميل أو الطباعة
        return doc.output('bloburl');
      }

      // تحميل كملف
      async function downloadPdf() {
        const canvas = await captureStickerCanvas();
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: [STICKER_MM.w, STICKER_MM.h]
        });
        doc.addImage(imgData, 'PNG', 0, 0, STICKER_MM.w, STICKER_MM.h);

        // اسم الملف يتضمن رقم الجهاز
        const phoneNumber = document.getElementById('phone-number').textContent || 'phone';
        const fileName = `barcode_${phoneNumber}.pdf`;
        doc.save(fileName);
      }

      // طباعة: نفتح في نافذة ونستدعي print()
      async function printPdf() {
        const url = await exportPdfBlobUrl();
        const win = window.open(url);
        if (!win) {
          alert('يرجى السماح بفتح النوافذ المنبثقة للطباعة.');
          return;
        }
        // ننتظر فتح النافذة ثم نطبع
        const onLoad = () => {
          win.focus();
          win.print();
        };
        if (win.document.readyState === 'complete') {
          onLoad();
        } else {
          win.onload = onLoad;
        }
      }

      // تحميل البيانات عند بدء الصفحة
      document.addEventListener('DOMContentLoaded', loadPhoneData);

      // أحداث الأزرار
      btnDownload?.addEventListener('click', (e) => { e.preventDefault(); downloadPdf(); });
      btnPrint?.addEventListener('click', (e) => { e.preventDefault(); printPdf(); });
    })();
  </script>
</body>
</html>
